<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VITAC â€” Visualizador de Tallas y Capturas (v0.4.10)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="">
/** Normaliza decimales y clasifica con cortes estrictos */
function parseDecimal(val) {
  if (val === null || val === undefined) return 0;
  if (typeof val === 'number') return isFinite(val) ? val : 0;
  const s = String(val).trim().replace(',', '.');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function getSabanaColor(rawVal) {
  const v = parseDecimal(rawVal);
  if (v === 0) return '#9e9e9e';       // gris SOLO 0
  if (v > 0 && v <= 640) return '#ffeb3b';     // amarillo
  if (v >= 641 && v <= 1280) return '#4caf50'; // verde
  if (v >= 1281 && v <= 2560) return '#2196f3';// azul
  if (v > 2560) return '#f44336';             // rojo
  return '#9e9e9e';
}

<script>
let sabanaLegendControl;

/* sabana map legend removed */
  sabanaLegendControl.addTo(map);
  try {
    const c = sabanaLegendControl.getContainer();
    if (c){
      c.style.zIndex = '10000';
      c.style.marginBottom = '8px'; // encima de la regla
      c.style.marginLeft = '8px';
    }
  } catch(_) {}
  // Re-attach guard: si alguien la esconde o remueve, la volvemos a mostrar
  try {
    const ctlRoot = document.querySelector('.leaflet-control-container');
    if (ctlRoot){
      const obs = new MutationObserver(()=>{
        const c = sabanaLegendControl && sabanaLegendControl.getContainer ? sabanaLegendControl.getContainer() : null;
        if (c && (c.style.display === 'none' || !c.isConnected)){
          sabanaLegendControl.addTo(map);
          c.style.display = 'block';
          c.style.zIndex = '10000';
        }
      });
      obs.observe(ctlRoot, {childList:true, subtree:true, attributes:true, attributeFilter:['style','class']});
      // legend observer removed
    }
  } catch(_) {}
  // En cada zoom, garantizamos visible
  map.on('zoomend moveend', ()=>{
    const c = sabanaLegendControl && sabanaLegendControl.getContainer ? sabanaLegendControl.getContainer() : null;
    if (c){ c.style.display = 'block'; c.style.zIndex = '10000'; }
  });
};

}

// Tweak legend container (lift above attribution and ensure top z-index)
try {
  const _c = sabanaLegendControl && sabanaLegendControl.getContainer ? sabanaLegendControl.getContainer() : null;
  if (_c){
    _c.style.zIndex = '10000';
    _c.style.marginBottom = '46px'; // lift above attribution bar
    _c.style.marginRight = '8px';
  }
} catch(_){}

</script>
</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --bg:#0b1020; --fg:#e9eef6; --muted:#94a3b8; --card:#141c30; --line:#26314e; --accent:#0ea5e9; --gap: 8px; --radius:14px; --logo:40px; }
    html[data-theme='light']{ --bg:#f5f7fb; --fg:#0f172a; --muted:#475569; --card:#ffffff; --line:#e2e8f0; --accent:#0ea5e9; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
    .app{display:grid;height:100vh;padding:var(--gap);gap:var(--gap);grid-template-columns:minmax(0,1fr) 500px; grid-template-rows:auto minmax(0,1fr);grid-template-areas:'header header' 'left right';}
    header{grid-area:header;background:var(--card);color:var(--fg);border:1px solid var(--line);border-radius:var(--radius);padding:10px 12px;display:flex;align-items:center;gap: 8px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    #logo{height:40px;cursor:pointer;transition:transform .2s ease,height .2s ease, filter .2s}
    #logo.big{height:72px; filter:drop-shadow(0 6px 12px rgba(0,0,0,.25));}
    .title{font-weight:700;letter-spacing:.3px}
    .title small{display:block;font-weight:500;color:var(--muted)}
    .upload{display:flex;align-items:center;gap:10px;flex:1;min-width:420px;color:var(--fg);flex-wrap:wrap}
    .upload label{font-size:12px;color:var(--muted)}
    .upload input[type=file]{padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:var(--card);color:var(--fg)}
    .status{font-size:12px;color:var(--muted)}
    .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .iconbtn{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:var(--card);cursor:pointer;padding:0}
    .iconbtn svg{width:20px;height:20px;stroke:var(--fg)}
    .iconbtn:hover{filter:brightness(1.06)}
    .left{grid-area:left;display:grid;gap:var(--gap);grid-template-rows:auto minmax(0,1fr);min-height:0}
    .lancebar{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px;display:grid;gap:10px;color:var(--fg)}
    .lancebar .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .tag{background:transparent;border:1px dashed var(--line);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .sep{flex:1;border-bottom:1px dashed var(--line);margin:4px 0}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card);color:var(--fg);cursor:pointer}
    .pill[data-state='on']{outline:2px solid var(--accent)}
    .lancescroll{display:flex;gap:6px;overflow:hidden;flex-wrap:wrap;padding-bottom:4px}
    .grid{display:grid;gap:var(--gap);height:100%;grid-template-columns:repeat(2,minmax(0,1fr));grid-template-rows:repeat(2,minmax(0,1fr));min-height:0;min-width:0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px;display:grid;grid-template-rows:auto minmax(0,1fr);min-height:0;min-width:0;color:var(--fg)}
    .card header{display:flex;align-items:center;gap:8px}
    .meta{margin-left:auto;font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .controls select,.controls button,.controls input[type=range]{padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:var(--bg);color:var(--fg)}
    .chartbox{min-height:0} .chartbox canvas{width:100% !important;height:100% !important}
    #cardSex .charts-row{display:flex;gap:8px;align-items:stretch}
    #cardSex .charts-row .chartbox{flex:1 1 0}
    .mapwrap{grid-area:right;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px;display:grid;grid-template-rows:auto minmax(0,1fr);gap:8px;min-height:0;color:var(--fg)}
    .maphead{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card);cursor:pointer;font-size:12px}
    .chip[data-active='true']{outline:2px solid var(--accent)}
    #map{height:100%;border:1px solid var(--line);border-radius:12px; position:relative;}
    .toolbar{display:flex;gap:6px;align-items:center;margin-left:auto}
    .ibtn{display:inline-grid;place-items:center;width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg);cursor:pointer}
    .ibtn svg{width:18px;height:18px}
    .mousepos{position:absolute;right:8px;top:8px;background:rgba(0,0,0,.45);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;backdrop-filter:blur(4px);z-index:500;white-space:nowrap}
    .leaflet-control.nautscale{background:rgba(0,0,0,.55);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;line-height:1.1;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .leaflet-control.nautscale .bar{height:6px;background:#fff;margin-top:4px;border-radius:3px}
    .legend{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.55);color:#fff;padding:8px 10px;border-radius:10px;font-size:12px;line-height:1.15}
    .legend .item{display:flex;align-items:center;gap:6px;margin:4px 0}
    .legend .dot{width:12px;height:12px;border-radius:999px;/* sin borde para igualar sÃ¡bana */}
    .dot.gray{background:#9ca3af}
    .dot.yellow{background:#facc15}
    .dot.green{background:#22c55e}
    .dot.blue{background:#3b82f6}
    .dot.red{background:#ef4444}
    .leaflet-tooltip.lanceLbl{background:transparent;border:none;box-shadow:none;color:#0b1020;font-weight:700;text-shadow:0 1px 2px rgba(255,255,255,.9),0 0 3px rgba(255,255,255,.9)}
    html[data-theme='dark'] .leaflet-tooltip.lanceLbl{color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.8), 0 0 3px rgba(0,0,0,.8);}
  
#cardScatter .controls-metrics{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  padding:4px 8px 0;
}
#lwMetrics.metric-pill{
  font-size:14px;
  color:var(--muted,#64748b);
  border-radius:9999px;
  padding:2px 8px;
  background:rgba(255,255,255,0.9);
  border:1px solid var(--panel-border,#e5e7eb);
  max-width:100%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

#cardFreq .controls-metrics{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  padding:4px 8px 0;
}
#freqMetrics.metric-pill{
  font-size:14px;
  color:var(--muted,#64748b);
  border-radius:9999px;
  padding:2px 8px;
  background:rgba(255,255,255,0.9);
  border:1px solid var(--panel-border,#e5e7eb);
  max-width:100%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

#cardSex .charts-row{display:flex;gap:8px;align-items:stretch}
#cardSex .charts-row .chartbox{flex:1 1 0}
#cardSex .sex-summary{margin-top:4px;font-size:11px;display:flex;justify-content:flex-start;}
#cardSex .sex-summary table{width:auto;border-collapse:collapse;}
#cardSex .sex-summary th{text-align:left;font-weight:500;padding-right:4px;}
#cardSex .sex-summary td{text-align:left;padding-left:4px;}


#cardSex .sex-summary{
  width:50%;
  margin-top:4px;
  font-size:11px;
  display:flex;
  justify-content:center;
}
#cardSex .sex-summary table{
  width:auto;
}

#cardSex .summary-row{
  display:flex;
  margin-top:4px;
  font-size:11px;
}
#cardSex .sex-summary,
#cardSex .ems-summary{
  flex:1;
  display:flex;
  justify-content:center;
}
#cardSex .sex-summary table,
#cardSex .ems-summary table{
  width:auto;
  border-collapse:collapse;
}
#cardSex .sex-summary th,
#cardSex .ems-summary th{
  text-align:left;
  font-weight:500;
  padding-right:4px;
}
#cardSex .sex-summary td,
#cardSex .ems-summary td{
  text-align:left;
  padding-left:4px;
}

#cardSex .sex-summary td:not(:last-child)::after,
#cardSex .ems-summary td:not(:last-child)::after{
  content:' |';
  padding-left:4px;
}


button.pill[aria-pressed="true"]{
  text-decoration: none;
  opacity: 1;
}
button.pill[aria-pressed="false"]{
  text-decoration: line-through;
  opacity: 0.6;
}
</style>

<style>
.leaflet-control-container { z-index: 1000; }
.sabana-legend { z-index: 1001; }
</style>


<style>
.leaflet-control-container { z-index: 10000 !important; }
.leaflet-bottom.leaflet-right .leaflet-control { margin-bottom: 8px; }
</style>


<style>
.leaflet-control-container { z-index: 20000 !important; }
.leaflet-bottom.leaflet-left .leaflet-control { margin-bottom: 8px; }
</style>


<style id="contrast-theme-patch">
:root{
  --bg: #ffffff;
  --fg: #0f172a;           /* slate-900 */
  --fg-muted: #334155;     /* slate-700 */
  --panel-bg: #ffffff;
  --panel-border: #e2e8f0; /* slate-200 */
  --chip-bg: #f8fafc;      /* slate-50 */
  --chip-fg: #0f172a;
  --chip-border: #e2e8f0;
  --btn-bg: #ffffff;
  --btn-fg: #0f172a;
  --btn-border: #e2e8f0;
  --tooltip-bg:#ffffff;
  --tooltip-fg:#0f172a;
}

[data-theme="dark"], .dark{
  --bg: #0b1220;           /* near navy */
  --fg: #e5e7eb;           /* slate-200 */
  --fg-muted: #cbd5e1;     /* slate-300 */
  --panel-bg: #0f172a;     /* slate-900 */
  --panel-border: #1f2937; /* slate-800 */
  --chip-bg: #111827;      /* slate-900 */
  --chip-fg: #e5e7eb;
  --chip-border: #374151;  /* slate-700 */
  --btn-bg: #111827;
  --btn-fg: #e5e7eb;
  --btn-border: #374151;
  --tooltip-bg:#111827;
  --tooltip-fg:#e5e7eb;
}

/* Global */
body{ background: var(--bg); color: var(--fg); }
h1,h2,h3,h4,h5,h6, label, span, p, small, b, strong, i, em{ color: var(--fg); }
.card, .panel, .box, .container{ background: var(--panel-bg); border-color: var(--panel-border); color: var(--fg); }

/* Chips */
#sabanaChips, .chips, .chip{ color: var(--chip-fg); }
.chip{ background: var(--chip-bg); border:1px solid var(--chip-border); }
.chip.active{ outline:2px solid #60a5fa; } /* visible in dark */

/* Buttons / icon buttons */
button, .ibtn{ background: var(--btn-bg); color: var(--btn-fg); border-color: var(--btn-border); }
button svg, .ibtn svg{ color: var(--btn-fg); stroke: currentColor; display:block; }

/* Linear legend */
#sabanaLinearLegend{ color: var(--fg); }
#sabanaLinearLegend .legend-linear{ background: var(--panel-bg); box-shadow: none; border:1px solid var(--panel-border); }
#sabanaLinearLegend .legend-item{ color: var(--fg); }

/* Mouse pos badge */
#mousePos{ background: var(--panel-bg); color: var(--fg); border:1px solid var(--panel-border); }

/* Leaflet controls / tooltips */
.leaflet-control-attribution, .leaflet-control-layers, .leaflet-bar a{
  background: var(--panel-bg);
  color: var(--fg);
  border-color: var(--panel-border);
}
.leaflet-bar a, .leaflet-bar a:hover{ color: var(--fg); }
.leaflet-tooltip{
  background: var(--tooltip-bg);
  color: var(--tooltip-fg);
  border:1px solid var(--panel-border);
}
.leaflet-control-scale-line{
  background: var(--panel-bg);
  color: var(--fg);
  border-color: var(--panel-border);
}

/* Popup especÃ­fico de lances (hover fecha) */
.leaflet-popup.lancePopup .leaflet-popup-content-wrapper{
  background: var(--tooltip-bg);
  color: var(--tooltip-fg);
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,.45);
  border:1px solid var(--panel-border);
}
.leaflet-popup.lancePopup .leaflet-popup-tip{
  background: var(--tooltip-bg);
  border:1px solid var(--panel-border);
}
</style>


<style id="legend-compact-tweak">
@media (max-width: 1024px){
  #sabanaLinearLegend .legend-linear { font-size: 10.5px; gap: 6px; padding: 3px 5px; }
  #sabanaLinearLegend .legend-swatch { width: 12px; height: 9px; }
}
</style>


<style id="legend-unit-css">
#sabanaLinearLegend .legend-unit { opacity: 1; }
</style>





<style id="compact-upload-css">
.upload.compact { gap:8px; }
.upload .filetag {
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none;
  border:1px solid var(--btn-border); background:var(--btn-bg); color:var(--btn-fg);
  font-weight:600; box-shadow: inset 0 1px 0 rgba(0,0,0,.04);
}
.upload .filetag input[type="file"]{ display:none; }
.upload .fname { font-size:12px; opacity:.8; display:none; }
.upload .filetag.has-file { border-color:#22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.15); }
@media (max-width: 980px){
  .upload .fname{ display:none; }
}
</style>


<style id="capturas-chart-css">
#capturasPanel{
  margin-top: 10px; padding: 10px 12px; border-radius: 12px;
  background: var(--panel-bg); border:1px solid var(--panel-border);
}
#capturasPanel h3{ margin: 0 0 8px 0; font-size: 14px; color: var(--fg); }
#capturasChart{ width: 100%; height: 280px; }
#capturasChart .bar{ transition: opacity .15s ease, transform .05s ease; }
#capturasChart .bar:hover{ opacity: .9; }
#capturasChart .axis text{ font-size: 11px; fill: var(--fg); }
#capturasChart .axis line, #capturasChart .axis path{ stroke: var(--panel-border); }
#capturasChart .tooltip{
  position:absolute; pointer-events:none; padding:6px 8px; font-size:12px;
  border-radius:8px; border:1px solid var(--panel-border); background: var(--tooltip-bg); color: var(--tooltip-fg);
  transform: translate(-50%, -120%); white-space:nowrap;
}
</style>

<style id="hide-panel-captions-css">
  /* Oculta el rÃ³tulo inferior (caption) en todos los paneles de grÃ¡ficos */
  .panel-caption { display: none !important; }
</style>

  <style>
    #freqSpeciesPills{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    #freqSpeciesPills .species-pill{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      font-size:11px;
      cursor:pointer;
    }
    #freqSpeciesPills .species-pill.selected{
      border-color:var(--accent);
      background:rgba(14,165,233,0.08);
      color:var(--accent);
    }
    /* ocultamos el selector original pero lo dejamos en el DOM */
    #speciesSel,
    label[for="speciesSel"]{
      display:none;
    }
  </style>


<style>
.leaflet-control-attribution{
  display:none !important;
}
</style>

<style>
.leaflet-pane.transect-pane { z-index: 460 !important; }
.leaflet-pane.track-pane { z-index: 455 !important; }

.tran-label {
  font: 11px/1.1 "Inter", system-ui, sans-serif;
  color: #111827;
  text-shadow: 0 0 2px rgba(255,255,255,0.85), 0 0 6px rgba(255,255,255,0.95);
  white-space: nowrap;
}
</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <img id="logo" alt="VITAC" src="./Vitac2.png" />
        <div class="title">VITAC â€” Visualizador de Tallas y Capturas
          <small>AdriÃ¡n Ibieta - Jairo GutiÃ©rrez</small>
        </div>
      </div>
      
<div class="upload compact">

  <label class="filetag" for="excelInput">ðŸ“š Excel maestro
    <input id="excelInput" type="file" accept=".xlsx,.xls,.xlsm,.xlsb">
    <span class="fname" id="fn_excel">â€”</span>
  </label>

  <div class="substatus">
    <span class="fname" id="fn_lances">Lances: â€”</span>
    <span class="fname" id="fn_sabana">SÃ¡bana: â€”</span>
    <span class="fname" id="fn_capturas">Capturas: â€”</span>
    <span class="fname" id="fn_bio">BiometrÃ­a: â€”</span>
    <span class="fname" id="fn_mapextra">Est. Oceano: â€”</span>
    <span class="fname" id="fn_numtr">Num. Tr: â€”</span>
    <span class="fname" id="fn_track">Track: â€”</span>
  </div>

  <div class="status" id="fileStatus">0/7 Â· esperando Excel maestroâ€¦</div>

</div>
<div class="actions">
        <button id="themeBtn" class="iconbtn" aria-label="Cambiar tema" title="Cambiar tema">
          <svg id="iconSun"  viewBox="0 0 24 24" fill="none" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
          <svg id="iconMoon" viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
        <button id="fsBtn" class="iconbtn" aria-label="Pantalla completa" title="Pantalla completa">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3M16 3h3a2 2 0 0 1 2 2v3M8 21H5a2 2 0 0 1-2-2v-3M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
        </button>
        <button id="btnFit" class="pill" title="Centrar lances">Centrar lances</button>
        <button id="btnEstOceano" class="pill" title="Mostrar/Ocultar estaciones oceÃ¡nicas" aria-pressed="true">
          Est. Oceano
        </button>
        <button id="btnNumTr" class="pill" title="Mostrar/Ocultar nÃºmeros de transecta" aria-pressed="true">
          Num. Tr
        </button>
        <button id="btnTrack" class="pill" title="Mostrar/Ocultar tracks" aria-pressed="true">
          Track
        </button>
      </div>
    </header>

    <div class="left">
      <section class="lancebar" id="lancebar">
        <div class="row">
          <span class="tag">Lances</span>
          <button class="pill" id="btnAll">Todos</button>
          <button class="pill" id="btnClear">Limpiar</button>
          <button class="pill" id="btnMulti" data-state="off">Comparar</button>
          <div class="sep"></div>
          <label for="speciesSel" style="font-size:12px">Especie</label>
          <select id="speciesSel"><option value="">(todas)</option></select>
          <span class="tag" id="selCount">0 seleccionados</span>
        </div>
        <div class="lancescroll" id="lanceBtns" aria-label="Botonera de lances"></div>
        <div id="freqSpeciesPills"></div>
      </section>

      <section class="grid">
        <article class="card" id="cardFreq">
          
          <div class="controls controls-metrics">
            <div class="controls-main">
<label for="binSel">Bin (cm)</label>
            <select id="binSel"><option>0.5</option><option selected>1</option><option>2</option><option>5</option></select>
            <button id="modeFreq" class="pill" style="padding:4px 12px; border-radius:9999px; border:1px solid var(--panel-border,#e5e7eb); background:var(--panel-bg,#fff); font-size:12px;">Barras/LÃ­nea</button>
            </div>
            <div id="freqMetrics" class="metric-pill"></div>
          </div>
          <div class="chartbox" style="position:relative;"><button id="freqUnitToggle" title="Alternar n/%" style="position:absolute; z-index:3; padding:4px 10px; font-size:12px; border-radius:9999px; border:1px solid var(--panel-border,#e5e7eb); background: var(--panel-bg,#fff); color: var(--fg,#0f172a); bottom:8px; left:8px;">%</button><canvas id="freqChart"></canvas></div>
        </article>

        <article class="card" id="cardScatter">
          <div class="controls controls-metrics">
            <div id="lwMetrics" class="metric-pill"></div>
          </div>
          <div class="chartbox" style="position:relative;">
            <canvas id="scatterChart"></canvas>
          </div>
        </article>

        <article class="card" id="cardCap">
          
          <div class="chartbox"><div id="capChartWrap" class="chart-wrap" style="position:relative; width:100%; height:100%;">
<button id="capUnitToggle" title="Alternar Kg/%" style="position:absolute;   z-index:3; padding:4px 10px; font-size:12px; border-radius:9999px; border:1px solid var(--panel-border,#e5e7eb); background: var(--panel-bg,#fff); color: var(--fg,#0f172a); bottom:8px; left:8px;">kg</button>
<canvas id="capChart" style="width:100%;height:420px;max-height:60vh;" style="width:100%;height:460px;max-height:70vh;"></canvas>
</div></div>
        </article>

        <article class="card" id="cardSex">
          <div class="charts-row">
            <div class="chartbox" style="height:260px;"><canvas id="sexChart"></canvas></div>
            <div class="chartbox" style="height:260px;"><canvas id="emsChart"></canvas></div>
          </div>
          <div class="summary-row">
            <div class="sex-summary">
              <table>
                <tbody id="sexSummaryBody">
                  <tr>
                    <th>% Machos</th><td>â€”</td>
                    <th>% Hembras</th><td>â€”</td>
                    <th>% Indet.</th><td>â€”</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="ems-summary">
              <table>
                <tbody id="emsSummaryBody">
                  <tr>
                    <th>N individuos</th><td>â€”</td>
                    <th>N con EMS</th><td>â€”</td>
                    <th>% con EMS</th><td>â€”</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </article>
      </section>
    </div>

    <aside class="mapwrap">
      <div class="maphead">
        <h3 style="margin:0">Mapa</h3>
        <div class="chips" id="sabanaChips" title="Especies de la SÃ¡bana (desde columna D)"></div>

<div id="sabanaLinearLegend" aria-label="Leyenda SÃ¡bana" style="display:none; margin-top:4px;">
  <style>
    .legend-linear {
      display:flex; align-items:center; gap: 8px; flex-wrap:wrap;
      background: rgba(255,255,255,0.96);
      border-radius: 8px; padding: 4px 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font: 11px/1.1 \"Inter\", system-ui, sans-serif;
    }
    .legend-item { display:flex; align-items:center; gap:6px; }
    .legend-swatch { width: 14px; height: 10px; border-radius:3px; display:inline-block; }
  </style>
  <div class="legend-linear">
    <div class="legend-item legend-unit"><b>sA</b></div>
    <div class="legend-item"><span class="legend-swatch" style="background:#9e9e9e"></span><span>= 0</span></div>
    <div class="legend-item"><span class="legend-swatch" style="background:#ffeb3b"></span><span>0 < v â‰¤ 640</span></div>
    <div class="legend-item"><span class="legend-swatch" style="background:#4caf50"></span><span>641â€“1280</span></div>
    <div class="legend-item"><span class="legend-swatch" style="background:#2196f3"></span><span>1281â€“2560</span></div>
    <div class="legend-item"><span class="legend-swatch" style="background:#f44336"></span><span>> 2560</span></div>
  </div>
</div>

        <div class="toolbar">
          <button class="ibtn" id="btnBase" title="Base: OSM (clic para cambiar)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 7l9-4 9 4-9 4-9-4z"></path>
              <path d="M3 17l9 4 9-4"></path>
              <path d="M3 12l9 4 9-4"></path>
            </svg>
          </button>
          <button class="ibtn" id="btnToggleSabana" title="Mostrar/ocultar SÃ¡bana"><span class="sr-only">Mostrar/Ocultar</span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
      <div id="map" role="region" aria-label="Mapa Leaflet">
        <div class="mousepos" id="mousePos">â€”</div>
<div class="legend" id="legend" style="display:none">
          <div class="item"><span class="dot gray"></span><span>0</span></div>
          <div class="item"><span class="dot yellow"></span><span>1 â€“ 640</span></div>
          <div class="item"><span class="dot green"></span><span>641 â€“ 1280</span></div>
          <div class="item"><span class="dot blue"></span><span>1281 â€“ 2560</span></div>
          <div class="item"><span class="dot red"></span><span>&gt; 2560</span></div>
        </div>
      </div>
    </aside>
  </div>

<script>
  function setTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    document.getElementById('logo').src = (mode==='light') ? './Vitac2.png' : './Vitac1.png';
    document.getElementById('iconSun').style.display = (mode==='light') ? 'none' : '';
    document.getElementById('iconMoon').style.display = (mode==='light') ? '' : 'none';
  }
  setTheme('light');
  document.getElementById('themeBtn').addEventListener('click', function(){
    var cur=document.documentElement.getAttribute('data-theme');
    setTheme(cur==='dark' ? 'light' : 'dark');
  });
  document.getElementById('logo').addEventListener('click', function(){ var el=this; if(el.className.indexOf('big')>-1){ el.className=el.className.replace('big','').trim(); } else { el.className=(el.className+' big').trim(); } });
  document.getElementById('fsBtn').addEventListener('click', function(){ if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } });
</script>

<script>
  // Utils
  function info(msg){ document.getElementById('fileStatus').textContent = msg; console.log(msg); }
  function toNum(v){ if(v==null||v==='') return NaN; if(typeof v==='number') return v; return Number(String(v).trim().replace(',','.')); }
  function toDM(val, isLat){ const hemi=isLat?(val<0?'S':'N'):(val<0?'W':'E'); const abs=Math.abs(val); const deg=Math.floor(abs); const min=(abs-deg)*60; const minStr=min.toFixed(1).replace('.', ','); const degPad=isLat?String(deg).padStart(2,'0'):String(deg).padStart(3,'0'); const minPad=(parseFloat(min.toFixed(1))<10?'0':'')+minStr; return `${degPad}Â°${minPad}' ${hemi}`; }
  const KEY_ALIASES={'lance_id':['lance_id','lance','idlance','id_lance','id','haul','set','lanceid'],'date':['date','fecha','fechahora','datetime'],'species':['species','especie'],'length_cm':['length_cm','length','largo_cm','longitud_cm','lt','len'],'weight_g':['weight_g','weight','peso_g','peso'],'sex':['sex','sexo'],'catch_kg':['catch_kg','catch','captura_kg','captura','kg'],'lat':['lat','latitude','latitud','y'],'lon':['lon','lng','long','longitud','x'],'Lat_M':['lat_m','latm','lat_metros','lat__m','lat__min'],'Lon_M':['lon_m','lonm','lon_metros','lon__m','lon__min']};
  KEY_ALIASES.ems=['ems','Ems','ems_madurez','madurez','estado_madurez','sexual'];
  function stdKey(k){ const kl=String(k||'').trim(); const low=kl.toLowerCase(); for(const std in KEY_ALIASES){ if(std.toLowerCase()===low) return std; if(KEY_ALIASES[std].some(alias=>alias.toLowerCase()===low)) return std; } return kl; }
</script>

<script>
  // Lances (igual que v0.4.9)
  let RAW=[], LANCES=[], BY_LANCE=new Map(), SPECIES=new Set();
  // Estado de selecciÃ³n de lances y especies
  let selectedLances=new Set(), multi=false;
  // SelecciÃ³n de especies: string legacy + Set para multi-selecciÃ³n
  let selectedSpecies="", selectedSpeciesSet=new Set();
  window.selectedSpeciesSet = selectedSpeciesSet;
  const elSpecies=document.getElementById('speciesSel');
  const elLanceBtns=document.getElementById('lanceBtns');
  const elSelCount=document.getElementById('selCount');
  const elFile=document.getElementById('fileInput');

  function parseFiles(files){ const tasks=[]; for(const f of files){ tasks.push(new Promise((res,rej)=>{ Papa.parse(f,{ header:true,dynamicTyping:false,skipEmptyLines:true,delimiter:'', complete:(r)=>res(r.data), error:rej }); })); } Promise.all(tasks).then(chunks=>{ loadRows(chunks.flat()); }).catch(err=>{ console.error(err); alert('Error leyendo CSV de lances: '+err); }); }
  
const SPECIES_CANON = {
  "Sardina comun": "Sardina comÃºn",
  "Sardina comÃºn": "Sardina comÃºn",
  "Sardina comÃºn": "Sardina comÃºn"
};

function normalizeSpecies(s){
  if (!s) return "";
  let t = String(s).trim();
  // corregir variantes con caracter roto por tilde
  t = t.replace('Sardina com n','Sardina comÃºn');
  t = t.replace('Sardina Com n','Sardina comÃºn');
    // Usar clave normalizada (sin tildes, mayÃºsculas/minÃºsculas, espacios duplicados)
  if (typeof normKey === 'function'){
    const nk = normKey(t);
    for (const key in SPECIES_CANON){
      if (!Object.prototype.hasOwnProperty.call(SPECIES_CANON, key)) continue;
      const nkKey = normKey(key);
      if (nkKey === nk) {
        return SPECIES_CANON[key];
      }
    }
  }

  return SPECIES_CANON[t] || t;
}

function normalizeRow(row){ const r={}; for(const k in row){ const v=row[k]; r[stdKey(k)]=v; } if('lat'in r) r.lat=toNum(r.lat); if('lon'in r) r.lon=toNum(r.lon); if('length_cm'in r) r.length_cm=toNum(r.length_cm); if('weight_g'in r) r.weight_g=toNum(r.weight_g); if('catch_kg'in r) r.catch_kg=toNum(r.catch_kg); if('sex'in r && typeof r.sex==='string') r.sex=r.sex.trim().toUpperCase()[0]||'U'; if('lance_id'in r){ const n=toNum(r.lance_id); r.lance_id=isNaN(n)?String(r.lance_id).trim():n; } return r; }
  function loadRows(rows){ const norm=rows.map(normalizeRow); const mapRows=norm.filter(r=>r.lance_id!=null && !Number.isNaN(r.lat) && !Number.isNaN(r.lon)); RAW=norm; const m=new Map(); const dmap=new Map(); SPECIES.clear(); for(const r of mapRows){ if(!m.has(r.lance_id)) m.set(r.lance_id,[]); m.get(r.lance_id).push(r); if(r.date && !dmap.has(r.lance_id)) dmap.set(r.lance_id,new Date(r.date)); } norm.forEach(r=>{ if(r.species) SPECIES.add(r.species); }); BY_LANCE=m; LANCES=Array.from(m.keys()).sort((a,b)=>{ const da=dmap.get(a),db=dmap.get(b); if(da&&db) return da-db; const na=Number(a), nb=Number(b); if(!isNaN(na)&&!isNaN(nb)) return na-nb; return String(a).localeCompare(String(b)); }); elSpecies.innerHTML='<option value="">(todas)</option>'+Array.from(SPECIES).sort().map(s=>`<option>${s}</option>`).join(''); elLanceBtns.innerHTML=''; for(const id of LANCES){ const b=document.createElement('button'); b.className='pill'; b.textContent= String(id); b.dataset.id=id; b.onclick=()=>toggleLance(id,b); elLanceBtns.appendChild(b); } selectedLances=new Set(LANCES); refreshLanceButtons(); updateAll(); drawLanceMarkers(); fitToLances(); const nBio=norm.filter(r=>(r.length_cm||r.weight_g||r.species||r.catch_kg)).length; info(`Lances: ${norm.length} filas Â· ${LANCES.length} lances (mapa) Â· filas con biologÃ­a: ${nBio}`); }
  if (elFile) elFile.addEventListener('change', e=>{ const f=e.target.files; if(!f||f.length===0){ info('Sin archivos'); return; } parseFiles(f); });

  elSpecies.addEventListener('change', e=>{
    const val = e.target.value || "";
    selectedSpecies = val;
    // sincroniza el Set multi-especie: una sola especie desde este selector
    selectedSpeciesSet.clear();
    if (val){
      const norm = (typeof normalizeSpecies==='function') ? normalizeSpecies(val) : val;
      selectedSpeciesSet.add(norm);
    }
    updateAll();
  });

  function toggleLance(id){ if(!multi){ selectedLances.clear(); } if(selectedLances.has(id)){ selectedLances.delete(id); } else { selectedLances.add(id); } refreshLanceButtons(); updateAll(); drawLanceMarkers(); fitToLances(); }
  function refreshLanceButtons(){ elSelCount.textContent=`${selectedLances.size} seleccionados`; [...elLanceBtns.children].forEach(k=>{ const id=k.dataset.id; k.dataset.state=selectedLances.has(id)?'on':'off'; }); document.getElementById('btnMulti').dataset.state=multi?'on':'off'; }
  document.getElementById('btnAll').onclick=()=>{ selectedLances=new Set(LANCES); refreshLanceButtons(); updateAll(); drawLanceMarkers(); fitToLances(); };
  document.getElementById('btnClear').onclick=()=>{ selectedLances.clear(); refreshLanceButtons(); updateAll(); drawLanceMarkers(); };
  document.getElementById('btnMulti').onclick=()=>{ multi=!multi; refreshLanceButtons(); updateAll(); };
  
// Color base para los grÃ¡ficos (usa la variable CSS --accent)
const accentStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
const BASE_COLOR = (accentStyle && accentStyle.trim()) || '#0ea5e9';

// Frecuencia (lÃ­nea) con color desde el inicio
const freqChart = new Chart(document.getElementById('freqChart'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Frecuencia',
      data: [],
      borderColor: BASE_COLOR,
      backgroundColor: 'rgba(14,165,233,0.18)',
      tension: 0.2,
      pointRadius: 3,
      pointHoverRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: {
      padding: { top: 8, right: 8, bottom: 4, left: 4 }
    },
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          usePointStyle: true,
          boxWidth: 10,
          filter: function(item, data){
            var ds = data && data.datasets ? data.datasets[item.datasetIndex] : null;
            if (!ds) return true;
            // Oculta de la leyenda las lÃ­neas de lÃ­mite
            if (ds.label && /^LÃ­mite /.test(ds.label)) return false;
            return true;
          }
        }
      },
      tooltip: {
        callbacks: {
          label: function(ctx){
            var label = ctx.dataset && ctx.dataset.label ? ctx.dataset.label + ': ' : '';
            var ds = ctx.dataset || {};
            var idx = ctx.dataIndex;
            if (Array.isArray(ds._counts) && idx != null && idx >= 0 && idx < ds._counts.length) {
              var n = ds._counts[idx] || 0;
              var total = ds._totalN || 0;
              var pct = total > 0 ? (n * 100 / total) : 0;
              var nStr = n.toLocaleString('es-CL');
              var pctStr = pct.toLocaleString('es-CL', {maximumFractionDigits:1});
              return label + nStr + ' ind (' + pctStr + ' %)';
            }
            var v = ctx.parsed && ctx.parsed.y != null ? ctx.parsed.y : ctx.raw;
            if (v == null) return label || '';
            var num = Number(v);
            if (!isFinite(num)) return label + v;
            if (window.FREQ_UNIT === 'pct') {
              return label + num.toLocaleString('es-CL', {maximumFractionDigits:1}) + ' %';
            } else {
              return label + num.toLocaleString('es-CL');
            }
          }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          callback: function(value, index, ticks){
            try{
              var isPel = !!window.isPelagicCurrent;
              var label = this.getLabelForValue ? this.getLabelForValue(value) : (ticks && ticks[index] && (ticks[index].label != null ? ticks[index].label : ticks[index].value));
              if (label == null) return '';
              var num = Number(label);
              if (!isFinite(num)) return label;
              if (isPel){
                return num.toFixed(1).replace('.', ',');
              } else {
                return String(Math.round(num));
              }
            } catch(e){
              if (this.getLabelForValue) return this.getLabelForValue(value);
              return value;
            }
          }
        }
      }
    }
  }
});
window.freqChart = freqChart;

// L-W (scatter) con color base (luego se ajusta por especie o por lance)
const scatterChart = new Chart(document.getElementById('scatterChart'), {
  type: 'scatter',
  data: {
    datasets: [{
      label: 'L-W',
      data: [],
      backgroundColor: 'transparent',
      borderColor: BASE_COLOR,
      pointRadius: 3,
      pointHoverRadius: 4,
      pointBackgroundColor: 'transparent',
      pointBorderColor: BASE_COLOR
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: {
      padding: { top: 8, right: 8, bottom: 4, left: 4 }
    },
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          usePointStyle: true,
          boxWidth: 10,
          filter: function(item, data){
            var ds = data && data.datasets ? data.datasets[item.datasetIndex] : null;
            if (!ds) return true;
            // Oculta de la leyenda las lÃ­neas de lÃ­mite
            if (ds.label && /^LÃ­mite /.test(ds.label)) return false;
            return true;
          }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          callback: function(value){
            try{
              var num = Number(value);
              if (!isFinite(num)) return value;
              if (window.isPelagicCurrent){
                return num.toFixed(1).replace('.', ',');
              } else {
                return String(Math.round(num));
              }
            } catch(e){
              return value;
            }
          }
        }
      }
    }
  }
});
window.scatterChart = scatterChart;

// Capturas
const capChart = new Chart(document.getElementById('capChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'kg', data: [] }] },
  options: { responsive: true, maintainAspectRatio: false }
});
window.capChart = capChart;

// ProporciÃ³n sexual
const sexChart = new Chart(document.getElementById('sexChart'), {
  type: 'doughnut',
  data: {
    labels: ['Machos', 'Hembras', 'Indet.'],
    datasets: [{
      data: [0, 0, 0],
      backgroundColor: ['#3b82f6', '#fb7185', '#9ca3af'],
      borderColor: ['#1d4ed8', '#be123c', '#6b7280'],
      borderWidth: 1,
      rawCounts: [0, 0, 0]
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const label = ctx.label || '';
            const valuePct = ctx.raw ?? 0;
            const ds = ctx.dataset || {};
            const rawCounts = ds.rawCounts || [];
            const idx = ctx.dataIndex ?? 0;
            const n = rawCounts[idx] ?? 0;
            const pctTxt = (typeof valuePct === 'number') ? valuePct.toFixed(1) + '%' : valuePct + '%';
            return label + ': ' + pctTxt + ' (' + n + ' obs.)';
          }
        }
      }
    }
  }
});
window.sexChart = sexChart;

const emsChart = new Chart(document.getElementById('emsChart'), {
  type: 'bar',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Machos',
        data: [],
        backgroundColor: '#3b82f6',
        borderColor: '#1d4ed8',
        borderWidth: 1,
        stack: 'sexo',
        rawCounts: []
      },
      {
        label: 'Hembras',
        data: [],
        backgroundColor: '#fb7185',
        borderColor: '#be123c',
        borderWidth: 1,
        stack: 'sexo',
        rawCounts: []
      },
      {
        label: 'Indet.',
        data: [],
        backgroundColor: '#9ca3af',
        borderColor: '#6b7280',
        borderWidth: 1,
        stack: 'sexo',
        rawCounts: []
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: true, position: 'top' },
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const label = ctx.dataset && ctx.dataset.label ? ctx.dataset.label : '';
            const valuePct = (ctx.parsed && (ctx.parsed.y ?? ctx.parsed)) ?? ctx.raw ?? 0;
            const ds = ctx.dataset || {};
            const rawCounts = ds.rawCounts || [];
            const idx = ctx.dataIndex ?? 0;
            const n = rawCounts[idx] ?? 0;
            const pctTxt = (typeof valuePct === 'number')
              ? valuePct.toFixed(1) + '%'
              : (valuePct != null ? String(valuePct) + '%' : '0%');
            return label + ': ' + pctTxt + ' (' + n + ' obs.)';
          }
        }
      }
    },
    scales: {
      x: {
        stacked: true
      },
      y: {
        stacked: true,
        beginAtZero: true,
        ticks: {
          callback: function(value) {
            return value + '%';
          }
        }
      }
    }
  }
});
window.emsChart = emsChart;

  document.getElementById('binSel').addEventListener('change', updateAll);
  function histogram(values,binSize){
  if(values.length===0) return {labels:[],counts:[]};
  const min=Math.min(...values), max=Math.max(...values);
  if(!isFinite(min)||!isFinite(max)) return {labels:[],counts:[]};
  const bins=Math.ceil((max-min)/binSize)+1;
  const counts=new Array(bins).fill(0);
  for(const v of values){
    const idx=Math.floor((v-min)/binSize);
    if(idx>=0&&idx<counts.length) counts[idx]++;
  }
  const baseLabels=counts.map((_,i)=>(min+i*binSize).toFixed(1));
  if(!baseLabels.length) return {labels:[],counts:[]};

  const labels=[];
  const outCounts=[];
  const first=parseFloat(baseLabels[0]);
  const last=parseFloat(baseLabels[baseLabels.length-1]);

  // punto previo a la primera talla observada
  labels.push((first-binSize).toFixed(1));
  outCounts.push(0);

  // puntos con datos
  for(let i=0;i<baseLabels.length;i++){
    labels.push(baseLabels[i]);
    outCounts.push(counts[i]);
  }

  // punto posterior a la Ãºltima talla observada
  labels.push((last+binSize).toFixed(1));
  outCounts.push(0);

  return {labels,counts:outCounts};
}
  
function currentRows(){
  return RAW.filter(r=>{
    // Filtro por lances (si no hay ninguno seleccionado, se consideran todos)
    const inLance = (selectedLances.size===0 || selectedLances.has(r.lance_id));

    // Filtro por especies: soporta multi-selecciÃ³n vÃ­a selectedSpeciesSet
    let inSpecies = true;
    if (selectedSpeciesSet && selectedSpeciesSet.size>0){
      const rawSp = r.species || "";
      const normSp = (typeof normalizeSpecies==='function') ? normalizeSpecies(rawSp) : rawSp;
      inSpecies = selectedSpeciesSet.has(normSp);
    } else if (selectedSpecies){
      // modo legado: una sola especie seleccionada
      inSpecies = r.species === selectedSpecies;
    }

    return inLance && inSpecies;
  });
}

  
// === Capturas renderer (single -> doughnut, multi -> stacked bar) ===

function renderCapturasChartUsingCaptData(selectedLancesSet){
  if (!window.CAPT_DATA || !Array.isArray(CAPT_DATA.rows) || !CAPT_DATA.rows.length) return;
  const idKey = CAPT_DATA.keyId || 'lance_id';
  const espKey = CAPT_DATA.keyEsp || 'especie';
  const kgKey  = CAPT_DATA.keyKg  || 'captura_k';

  const unit = (window.CAPT_UNIT === 'pct') ? 'pct' : 'kg';

  // Normalize selected ids: 'L12' -> '12'
  const selIds = new Set(Array.from(selectedLancesSet||[]).map(id => String(id).replace(/^L/i,'')));

  // Filter rows by selection (if any)
  const rows = CAPT_DATA.rows.filter(r => {
    const id = String(r[idKey]||'').trim();
    return (selIds.size ? selIds.has(id) : true);
  });

  // Count distinct lances in rows
  const lanceIds = Array.from(new Set(rows.map(r => String(r[idKey]||'').trim()))).filter(Boolean);

  const canvas = document.getElementById('capChart');
  if (!canvas || !window.Chart) return;
  const existing = Chart.getChart(canvas);
  if (existing) existing.destroy();

  const toNum = (x)=>{
    if (typeof x === 'number') return x;
    const s = (x||'').toString().replace(/\./g,'').replace(',', '.'); 
    const v = parseFloat(s);
    return isNaN(v) ? 0 : v;
  };

  if (lanceIds.length <= 1){
    // Doughnut: especies de un lance
    const bySpec = new Map();
    rows.forEach(r => {
      const esp = r[espKey] || 'â€”';
      bySpec.set(esp, (bySpec.get(esp)||0) + toNum(r[kgKey]));
    });
    const dataArr = Array.from(bySpec.entries()).sort((a,b)=>b[1]-a[1]);
    const labels = dataArr.map(d => d[0]);
    let values   = dataArr.map(d => d[1]);

    if (unit === 'pct'){
      const tot = values.reduce((a,b)=>a+b,0) || 1;
      values = values.map(v => v*100/tot);
    }

    new Chart(canvas, {
      type: 'doughnut',
      data: { labels, datasets: [{ label: (unit==='pct'?'%':'kg'), data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top', labels:{ boxWidth:14, boxHeight:14, font:{size:11} } },
          tooltip: { callbacks: { 
            label: (ctx)=> (ctx.label||'')+': '+(unit==='pct' ? ctx.parsed.toFixed(2)+' %' : ctx.parsed.toLocaleString('es-CL')+' kg')
          } }
        },
        cutout: '55%'
      }
    });
  } else {
    // Stacked bars: especies por lance
    const species = Array.from(new Set(rows.map(r => r[espKey] || 'â€”'))).sort();
    lanceIds.sort((a,b)=> (parseInt(a)||0)-(parseInt(b)||0));

    const map = new Map();
    lanceIds.forEach(id=>map.set(id, new Map()));
    rows.forEach(r => {
      const id = String(r[idKey]||'').trim();
      const esp = r[espKey] || 'â€”';
      const kg  = toNum(r[kgKey]);
      const m = map.get(id) || new Map();
      m.set(esp, (m.get(esp)||0)+kg);
      map.set(id, m);
    });

    const datasets = species.map((esp) => ({
      label: esp,
      data: lanceIds.map(id => (map.get(id)?.get(esp) || 0)),
      stack: 'stack1',
    }));

    if (unit === 'pct'){
      const totals = lanceIds.map(id => species.reduce((acc,esp)=> acc + (map.get(id)?.get(esp) || 0), 0) || 1);
      datasets.forEach(ds => { ds.data = ds.data.map((v,i)=> v*100/totals[i]); });
    }

    new Chart(canvas, {
      type: 'bar',
      data: { labels: lanceIds.map(id=>'L'+id), datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true },
          y: { stacked: true, min: 0, max: (unit==='pct'?100:undefined),
               ticks: { callback: (v)=> unit==='pct' ? (v+' %') : v.toLocaleString('es-CL') } }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: { callbacks: { 
            label: (ctx)=> ctx.dataset.label+': '+(unit==='pct' ? ctx.parsed.y.toFixed(2)+' %' : ctx.parsed.y.toLocaleString('es-CL')+' kg')
          } }
        }
      }
    });
  }
}


function updateAll(){
  const rows = currentRows();
  const selLancesArr = Array.from(selectedLances || []);
  const isMultiCompare = (typeof multi !== 'undefined' && multi && selLancesArr.length > 1);

  // === Frecuencia por talla ===
  const allLengths = rows
    .map(r => r.length_cm)
    .filter(v => v != null && !Number.isNaN(v));

  const binSel = document.getElementById('binSel');
  const binSize = Number(binSel ? binSel.value : 1) || 1;

  if (!allLengths.length || !isFinite(Math.min(...allLengths)) || !isFinite(Math.max(...allLengths))) {
    freqChart.data.labels = [];
    freqChart.data.datasets = [];
  } else {
    let minL = Math.min(...allLengths);
    let maxL = Math.max(...allLengths);

    // Intentar usar un rango fijo de talla definido por especie(s) (mono/multi especie)
    if (typeof getFixedLengthRangeForRows === 'function') {
      try {
        const fx = getFixedLengthRangeForRows(rows);
        if (fx && isFinite(fx.min) && isFinite(fx.max) && fx.max > fx.min) {
          minL = fx.min;
          maxL = fx.max;
        }
      } catch (e) {
        console.warn('Error aplicando rango fijo de tallas en Frecuencia:', e);
      }
    }

    const bins = Math.ceil((maxL - minL) / binSize) + 1;

    // etiquetas de eje X, replicando lÃ³gica de histogram()
    const baseLabels = [];
    for (let i = 0; i < bins; i++) {
      baseLabels.push((minL + i * binSize).toFixed(1));
    }
    const labels = [];
    const first = parseFloat(baseLabels[0]);
    const last = parseFloat(baseLabels[baseLabels.length - 1]);
    labels.push((first - binSize).toFixed(1));
    for (const lab of baseLabels) labels.push(lab);
    labels.push((last + binSize).toFixed(1));
    freqChart.data.labels = labels;

    const datasets = [];
    const unitIsPct = (window.FREQ_UNIT === 'pct');

    if (isMultiCompare) {
      // --- Comparativa por lance ---
      const perLanceCounts = new Map();
      for (const r of rows) {
        const L = r.length_cm;
        if (L == null || Number.isNaN(L)) continue;
        const idxBin = Math.floor((L - minL) / binSize);
        if (idxBin < 0 || idxBin >= bins) continue;
        const id = r.lance_id;
        let arr = perLanceCounts.get(id);
        if (!arr) {
          arr = new Array(bins).fill(0);
          perLanceCounts.set(id, arr);
        }
        arr[idxBin]++;
      }

      const palette = [
        '#0f766e','#dc2626','#7c3aed','#f97316',
        '#22c55e','#3b82f6','#e11d48','#581c87'
      ];
      let cIdx = 0;

      const lanceIds = Array.from(perLanceCounts.keys());
      for (const id of lanceIds) {
        const baseCounts = perLanceCounts.get(id) || new Array(bins).fill(0);
        const countsWithEdges = [0, ...baseCounts, 0];
        let yData = countsWithEdges;
        if (unitIsPct) {
          const total = countsWithEdges.reduce((a, b) => a + b, 0) || 1;
          yData = countsWithEdges.map(c => +(c * 100 / total).toFixed(1));
        }
        const col = palette[cIdx % palette.length];
        cIdx++;

        const total = countsWithEdges.reduce((a, b) => a + b, 0) || 0;

        datasets.push({
          label: `L${id}`,
          data: yData,
          borderColor: col,
          backgroundColor: 'transparent',
          tension: 0.2,
          pointRadius: 3,
          pointHoverRadius: 4,
          pointBackgroundColor: col,
          pointBorderColor: col,
          _counts: countsWithEdges,
          _totalN: total
        });
      }

        } else {
      const unitIsPct = (window.FREQ_UNIT === 'pct');
      const isBarMode = (freqChart && freqChart.config && freqChart.config.type === 'bar');

      if (isBarMode) {
        // --- Vista por sexo en barras apiladas ---
        const perSexCounts = new Map();
        for (const r of rows) {
          const L = r.length_cm;
          if (L == null || Number.isNaN(L)) continue;
          const idxBin = Math.floor((L - minL) / binSize);
          if (idxBin < 0 || idxBin >= bins) continue;

          // ClasificaciÃ³n de sexo coherente con el donut
          let v = r.sex;
          let key = 'Indet.';
          if (v != null && v !== '') {
            const s = String(v).trim().toUpperCase();
            if (s === '2' || s === 'H' || s === 'HEMBRA') {
              key = 'Hembras';
            } else if (s === '1' || s === 'M' || s === 'MACHO') {
              key = 'Machos';
            } else if (s === '3' || s === 'I' || s.startsWith('INDET')) {
              key = 'Indet.';
            } else {
              key = 'Indet.';
            }
          }

          let arr = perSexCounts.get(key);
          if (!arr) {
            arr = new Array(bins).fill(0);
            perSexCounts.set(key, arr);
          }
          arr[idxBin]++;
        }

        const sexOrder = ['Machos', 'Hembras', 'Indet.'];
        const sexFill = {
          'Machos': '#3b82f6',
          'Hembras': '#fb7185',
          'Indet.': '#9ca3af'
        };
        const sexBorder = {
          'Machos': '#1d4ed8',
          'Hembras': '#be123c',
          'Indet.': '#6b7280'
        };

        // Asegurar escalas apiladas en modo barras
        if (!freqChart.options.scales) {
          freqChart.options.scales = {};
        }
        if (!freqChart.options.scales.x) {
          freqChart.options.scales.x = {};
        }
        if (!freqChart.options.scales.y) {
          freqChart.options.scales.y = {};
        }
        freqChart.options.scales.x.stacked = true;
        freqChart.options.scales.y.stacked = true;
        freqChart.options.scales.y.min = 0;
        freqChart.options.scales.y.max = undefined;

        for (const key of sexOrder) {
          const baseCounts = perSexCounts.get(key) || new Array(bins).fill(0);
          const countsWithEdges = [0, ...baseCounts, 0];
          let yData = countsWithEdges;
          if (unitIsPct) {
            const total = countsWithEdges.reduce((a, b) => a + b, 0) || 1;
            yData = countsWithEdges.map(c => +(c * 100 / total).toFixed(1));
          }

          const total = countsWithEdges.reduce((a, b) => a + b, 0) || 0;

          datasets.push({
            label: key,
            data: yData,
            borderColor: sexBorder[key] || BASE_COLOR,
            backgroundColor: sexFill[key] || 'rgba(148,163,184,0.5)',
            stack: 'sexo',
            tension: 0,
            pointRadius: 0,
            pointHoverRadius: 0,
            borderWidth: 1.5,
            _counts: countsWithEdges,
            _totalN: total
          });
        }

      } else {
        // --- Vista por especie (inicio normal o un solo lance) ---
        const perSpeciesCounts = new Map();
        for (const r of rows) {
          const L = r.length_cm;
          if (L == null || Number.isNaN(L)) continue;
          const idxBin = Math.floor((L - minL) / binSize);
          if (idxBin < 0 || idxBin >= bins) continue;
          const spRaw = r.species || 'Sin especie';
          const sp = (typeof normalizeSpecies==='function') ? normalizeSpecies(spRaw) : spRaw;
          let arr = perSpeciesCounts.get(sp);
          if (!arr) {
            arr = new Array(bins).fill(0);
            perSpeciesCounts.set(sp, arr);
          }
          arr[idxBin]++;
        }

        const speciesList = Array.from(perSpeciesCounts.keys()).sort();
        // Escalas no apiladas en modo lÃ­nea
        if (!freqChart.options.scales) {
          freqChart.options.scales = {};
        }
        if (!freqChart.options.scales.x) {
          freqChart.options.scales.x = {};
        }
        if (!freqChart.options.scales.y) {
          freqChart.options.scales.y = {};
        }
        freqChart.options.scales.x.stacked = false;
        freqChart.options.scales.y.stacked = false;
        freqChart.options.scales.y.min = 0;
        freqChart.options.scales.y.max = undefined;

        for (const sp of speciesList) {
          const baseCounts = perSpeciesCounts.get(sp) || new Array(bins).fill(0);
          const countsWithEdges = [0, ...baseCounts, 0];
          let yData = countsWithEdges;
          if (unitIsPct) {
            const total = countsWithEdges.reduce((a, b) => a + b, 0) || 1;
            yData = countsWithEdges.map(c => +(c * 100 / total).toFixed(1));
          }
          const col = (typeof colorForSpecies === 'function')
            ? colorForSpecies(sp)
            : BASE_COLOR;

          const total = countsWithEdges.reduce((a, b) => a + b, 0) || 0;

          datasets.push({
            label: sp,
            data: yData,
            borderColor: col,
            backgroundColor: 'transparent',
            tension: 0.2,
            pointRadius: 3,
            pointHoverRadius: 4,
            pointBackgroundColor: col,
            pointBorderColor: col,
            _counts: countsWithEdges,
            _totalN: total
          });
        }
      }

    }


// --- LÃ­neas verticales de lÃ­mite en Frecuencia (todas las vistas, incluida multi-lance) ---
      if (typeof getSizeLimitForSpecies === 'function') {
        let maxY = 0;
        for (const ds of datasets) {
          if (!ds || !Array.isArray(ds.data)) continue;
          for (const v of ds.data) {
            const n = Number(v);
            if (!Number.isNaN(n) && n > maxY) maxY = n;
          }
        }
        const topY = maxY > 0 ? maxY * 1.05 : 1;

        const labelsNum = labels.map(l => Number(l));
        const limitDatasets = [];

        // Especies presentes en las filas filtradas que tengan lÃ­mite definido
        const speciesSetForLimits = new Set();
        for (const r of rows) {
          let spName = r && r.species != null ? r.species : null;
          if (!spName) continue;
          if (typeof normalizeSpecies === 'function') {
            spName = normalizeSpecies(spName);
          }
          const lim = getSizeLimitForSpecies(spName);
          if (typeof lim === 'number') {
            speciesSetForLimits.add(spName);
          }
        }
        const speciesList = Array.from(speciesSetForLimits).sort();

        for (const sp of speciesList) {
          const lim = getSizeLimitForSpecies(sp);
          if (typeof lim !== 'number') continue;

          let bestIdx = -1;
          let bestDiff = Infinity;
          for (let i = 0; i < labelsNum.length; i++) {
            const n = labelsNum[i];
            if (Number.isNaN(n)) continue;
            const d = Math.abs(n - lim);
            if (d < bestDiff) {
              bestDiff = d;
              bestIdx = i;
            }
          }
          if (bestIdx === -1) continue;

          const xVal = labels[bestIdx];

          const col = (typeof colorForSpecies === 'function')
            ? colorForSpecies(sp)
            : 'red';

          limitDatasets.push({
            label: `LÃ­mite ${sp}`,
            type: 'line',
            data: [
              { x: xVal, y: 0 },
              { x: xVal, y: topY }
            ],
            borderColor: col,
            borderWidth: 1.5,
            borderDash: [6, 4],
            pointRadius: 0,
            pointHoverRadius: 0,
            order: 999
          });
        }

        datasets.push(...limitDatasets);
      }    freqChart.data.datasets = datasets;
  }
  freqChart.update();

  // MÃ©tricas de Frecuencia (n, rango, moda y % bajo lÃ­mite legal si aplica)
  const freqMetricsEl = document.getElementById('freqMetrics');
  if (freqMetricsEl) {
    const lengthsForMetrics = allLengths || [];
    const nF = lengthsForMetrics.length;
    if (nF > 0) {
      let minL = lengthsForMetrics[0];
      let maxL = lengthsForMetrics[0];
      for (const v of lengthsForMetrics) {
        if (v < minL) minL = v;
        if (v > maxL) maxL = v;
      }

      // Moda estimada a partir del histograma (bin con mayor frecuencia)
      let modeL = null;
      try {
        if (typeof histogram === 'function' && typeof binSize === 'number') {
          const h = histogram(lengthsForMetrics, binSize);
          const lbls = (h && h.labels) ? h.labels : [];
          const cnts = (h && h.counts) ? h.counts : [];
          if (lbls.length === cnts.length && cnts.length > 0) {
            let maxIdx = 0;
            let maxVal = cnts[0];
            for (let i = 1; i < cnts.length; i++) {
              if (cnts[i] > maxVal) {
                maxVal = cnts[i];
                maxIdx = i;
              }
            }
            const mLabel = parseFloat(lbls[maxIdx]);
            if (!Number.isNaN(mLabel)) modeL = mLabel;
          }
        }
      } catch(e) {
        modeL = null;
      }

      // % bajo lÃ­mite legal (considerando solo filas con lÃ­mite definido)
      let pctBelow = null;
      if (typeof getSizeLimitForSpecies === 'function') {
        let countWithLimit = 0;
        let countBelow = 0;
        for (const r of rows) {
          const L = r.length_cm;
          if (L == null || Number.isNaN(L)) continue;
          let spName = r && r.species != null ? r.species : null;
          if (!spName) continue;
          if (typeof normalizeSpecies === 'function') {
            spName = normalizeSpecies(spName);
          }
          const lim = getSizeLimitForSpecies(spName);
          if (typeof lim !== 'number') continue;
          countWithLimit++;
          if (L < lim) countBelow++;
        }
        if (countWithLimit > 0) {
          pctBelow = (countBelow * 100) / countWithLimit;
        }
      }

            const isPel = !!window.isPelagicCurrent;
      const fmtLen = (val) => {
        if (val == null || !isFinite(val)) return 'â€”';
        if (isPel) {
          return val.toFixed(1).replace('.', ',');
        } else {
          return String(Math.round(val)).replace('.', ',');
        }
      };
      const fmtPct = (val) => {
        if (val == null || !isFinite(val)) return 'â€”';
        return val.toFixed(1).replace('.', ',');
      };

      let txt = `n=${nF.toLocaleString('es-CL')} | rango=${fmtLen(minL)}â€“${fmtLen(maxL)} cm`;
      if (modeL != null && isFinite(modeL)) {
        txt += ` | moda=${fmtLen(modeL)} cm`;
      }
      if (pctBelow != null && isFinite(pctBelow)) {
        txt += ` | <%LÃ­m=${fmtPct(pctBelow)}%`;
      }
      freqMetricsEl.textContent = txt;
    } else {
  freqMetricsEl.textContent = '';
    }
  }

  // === DispersiÃ³n L-W ===
  const lwPoints = rows.filter(r =>
    r.length_cm != null && r.weight_g != null &&
    !Number.isNaN(r.length_cm) && !Number.isNaN(r.weight_g)
  );

  const lwMetricsEl = document.getElementById('lwMetrics');
  if (lwMetricsEl) {
    const nLW = lwPoints.length;
    if (nLW) {
      let sumL = 0, sumW = 0;
      for (const r of lwPoints) {
        sumL += r.length_cm;
        sumW += r.weight_g;
      }
      const meanL = sumL / nLW;
      const meanW = sumW / nLW;

      // Ajuste de modelo potencia W = a * L^b en log-log y RÂ²
      let aLW = null, bLW = null, r2LW = null;
      let sumX = 0, sumY = 0, sumXX = 0, sumYY = 0, sumXY = 0, nReg = 0;
      for (const r of lwPoints) {
        const x = r.length_cm;
        const y = r.weight_g;
        if (x == null || y == null) continue;
        if (x <= 0 || y <= 0) continue;
        const lx = Math.log(x);
        const ly = Math.log(y);
        if (!isFinite(lx) || !isFinite(ly)) continue;
        sumX += lx;
        sumY += ly;
        sumXX += lx*lx;
        sumYY += ly*ly;
        sumXY += lx*ly;
        nReg++;
      }
      if (nReg >= 2) {
        const meanX = sumX / nReg;
        const meanY = sumY / nReg;
        const sxx = sumXX - nReg*meanX*meanX;
        const syy = sumYY - nReg*meanY*meanY;
        const sxy = sumXY - nReg*meanX*meanY;
        if (sxx !== 0 && syy > 0) {
          const b = sxy / sxx;
          const a = Math.exp(meanY - b*meanX);
          const r2 = (sxy*sxy) / (sxx*syy);
          if (isFinite(a) && isFinite(b)) {
            aLW = a;
            bLW = b;
          }
          if (isFinite(r2)) {
            r2LW = r2;
          }
        }
      }

      let txtLW = `n=${nLW} | Î¼L=${meanL.toFixed(1)} cm | Î¼W=${meanW.toFixed(1)} g`;

      // Solo mostramos ecuaciÃ³n y RÂ² cuando tambiÃ©n se dibuja la tendencia:
      //  - hay una sola especie activa (vÃ­a selectedSpecies o selectedSpeciesSet)
      //    (en modo multi-lance se toma la tendencia global de los puntos visibles)
      let hasSet = (typeof selectedSpeciesSet !== 'undefined' && selectedSpeciesSet && selectedSpeciesSet.size > 0);
      let hasSingleSpecies = false;
      if (hasSet && selectedSpeciesSet.size === 1) {
        hasSingleSpecies = true;
      } else if (!hasSet && window.selectedSpecies) {
        hasSingleSpecies = true;
      }
      let canShowTrendMetrics = hasSingleSpecies;

      if (canShowTrendMetrics && aLW != null && bLW != null) {
        const aTxt = aLW.toFixed(5).replace('.', ',');
        const bTxt = bLW.toFixed(2).replace('.', ',');
        txtLW += ` | W=${aTxt}Â·L^${bTxt}`;
      }
      if (canShowTrendMetrics && r2LW != null) {
        const r2Txt = r2LW.toFixed(3).replace('.', ',');
        txtLW += ` | RÂ²=${r2Txt}`;
      }
      lwMetricsEl.textContent = txtLW;
    } else {
      lwMetricsEl.textContent = 'n=0';
    }
  }
  const lwDatasets = [];
  if (isMultiCompare) {
    // --- Comparativa L-W por lance ---
    const perLanceLW = new Map();
    for (const r of lwPoints) {
      const id = r.lance_id;
      let arr = perLanceLW.get(id);
      if (!arr) {
        arr = [];
        perLanceLW.set(id, arr);
      }
      arr.push({ x: r.length_cm, y: r.weight_g });
    }

    const palette = [
      '#0f766e','#dc2626','#7c3aed','#f97316',
      '#22c55e','#3b82f6','#e11d48','#581c87'
    ];
    let cIdx = 0;
    const lanceIds = Array.from(perLanceLW.keys());
    for (const id of lanceIds) {
      const pts = perLanceLW.get(id) || [];
      const col = palette[cIdx % palette.length];
      cIdx++;

      lwDatasets.push({
        label: `L${id}`,
        data: pts,
        backgroundColor: 'transparent',
        borderColor: col,
        pointRadius: 3,
        pointHoverRadius: 4,
        pointBackgroundColor: 'transparent',
        pointBorderColor: col
      });
    }

  } else {
    // --- Vista L-W por especie ---
    const perSpeciesLW = new Map();
    for (const r of lwPoints) {
      const spRaw = r.species || 'Sin especie';
      const sp = (typeof normalizeSpecies==='function') ? normalizeSpecies(spRaw) : spRaw;
      let arr = perSpeciesLW.get(sp);
      if (!arr) {
        arr = [];
        perSpeciesLW.set(sp, arr);
      }
      arr.push({ x: r.length_cm, y: r.weight_g });
    }

    const speciesListLW = Array.from(perSpeciesLW.keys()).sort();
    for (const sp of speciesListLW) {
      const pts = perSpeciesLW.get(sp) || [];
      const col = (typeof colorForSpecies === 'function')
        ? colorForSpecies(sp)
        : BASE_COLOR;
      lwDatasets.push({
        label: sp,
        data: pts,
        backgroundColor: 'transparent',
        borderColor: col,
        pointRadius: 3,
        pointHoverRadius: 4,
        pointBackgroundColor: 'transparent',
        pointBorderColor: col
      });
    }
  }


  // --- LÃ­neas verticales de lÃ­mite en L-W (todas las vistas, incluida multi-lance) ---
  if (typeof getSizeLimitForSpecies === 'function') {
    let minY = Infinity;
    let maxY = -Infinity;
    for (const ds of lwDatasets) {
      if (!ds || !Array.isArray(ds.data)) continue;
      for (const p of ds.data) {
        if (!p || p.y == null) continue;
        const y = Number(p.y);
        if (Number.isNaN(y)) continue;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }
    if (!isFinite(minY) || !isFinite(maxY)) {
      minY = 0;
      maxY = 1;
    }
    const topY = maxY * 1.05;

    const limitDatasetsLW = [];
    // especies presentes en las filas filtradas que tengan lÃ­mite definido
    const speciesSetForLimits = new Set();
    for (const r of rows) {
      let spName = r && r.species != null ? r.species : null;
      if (!spName) continue;
      if (typeof normalizeSpecies === 'function') {
        spName = normalizeSpecies(spName);
      }
      const lim = getSizeLimitForSpecies(spName);
      if (typeof lim === 'number') {
        speciesSetForLimits.add(spName);
      }
    }
    const speciesList = Array.from(speciesSetForLimits).sort();

    for (const sp of speciesList) {
      const lim = getSizeLimitForSpecies(sp);
      if (typeof lim !== 'number') continue;

      const col = (typeof colorForSpecies === 'function')
        ? colorForSpecies(sp)
        : 'red';

      limitDatasetsLW.push({
        label: `LÃ­mite ${sp}`,
        type: 'line',
        data: [
          { x: lim, y: minY },
          { x: lim, y: topY }
        ],
        borderColor: col,
        borderWidth: 1.5,
        borderDash: [6, 4],
        pointRadius: 0,
        pointHoverRadius: 0
      });
    }

    lwDatasets.push(...limitDatasetsLW);
  }

scatterChart.data.datasets = lwDatasets;
  scatterChart.update();

  // --- Capturas por especie (renderer dedicado con CAPT_DATA) ---
  renderCapturasChartUsingCaptData(selectedLances);

  // --- ProporciÃ³n sexual (1=Macho, 2=Hembra, 3=Indet, tambiÃ©n acepta M/F/I texto) ---
  let hembras = 0, machos = 0, indet = 0;
  for (const r of rows) {
    let v = r.sex;
    if (v == null || v === '') continue;
    const s = String(v).trim().toUpperCase();
    if (s === '2' || s === 'H' || s === 'HEMBRA') {
      hembras++;
    } else if (s === '1' || s === 'M' || s === 'MACHO') {
      machos++;
    } else if (s === '3' || s === 'I' || s.startsWith('INDET')) {
      indet++;
    } else {
      indet++;
    }
  }

  if (sexChart && sexChart.data && sexChart.data.datasets && sexChart.data.datasets[0]) {
    const totalSex = machos + hembras + indet;
    window._vitacTotalSex = totalSex;
    let pctMachos = 0, pctHembras = 0, pctIndet = 0;
    if (totalSex > 0) {
      pctMachos = machos * 100 / totalSex;
      pctHembras = hembras * 100 / totalSex;
      pctIndet = indet * 100 / totalSex;
    }

    sexChart.data.labels = ['Machos', 'Hembras', 'Indet.'];
    sexChart.data.datasets[0].data = [pctMachos, pctHembras, pctIndet];
    sexChart.data.datasets[0].rawCounts = [machos, hembras, indet];
    sexChart.update();

    // Actualizar tabla resumen de sexo (solo porcentajes)
    const tbody = document.getElementById('sexSummaryBody');
    if (tbody) {
      const fmt = (x) => (x == null || !isFinite(x)) ? 'â€”' : x.toFixed(1).replace('.', ',') + '%';
      const row = tbody.querySelector('tr');
      if (row) {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 3) {
          cells[0].textContent = totalSex > 0 ? fmt(pctMachos) : 'â€”';
          cells[1].textContent = totalSex > 0 ? fmt(pctHembras) : 'â€”';
          cells[2].textContent = totalSex > 0 ? fmt(pctIndet) : 'â€”';
        }
      }
    }
  }

    
// --- Estados de madurez sexual (EMS) ---
  if (emsChart && emsChart.data && emsChart.data.datasets && emsChart.data.datasets.length >= 3) {
    // Mapa: clave EMS -> conteos por sexo
    const emsCounts = new Map();
    let totalEMS = 0;

    for (const r of rows) {
      // soporto varias posibles columnas: ems (normalizada), Ems original, sexo_ems, sexual
      let emsVal = r.ems;
      if (emsVal == null || emsVal === '') emsVal = r.Ems;
      if (emsVal == null || emsVal === '') emsVal = r.sexo_ems;
      if (emsVal == null || emsVal === '') emsVal = r.sexual;
      if (emsVal == null || emsVal === '') continue;

      let keyRaw = String(emsVal).trim();
      if (!keyRaw) continue;

      // Si es numÃ©rico (ej. "3.0"), compactar a entero si corresponde
      const num = Number(keyRaw.replace(',', '.'));
      const key = (!Number.isNaN(num) && Number.isFinite(num))
        ? (Number.isInteger(num) ? String(num) : String(num))
        : keyRaw;

      // Determinar categorÃ­a de sexo
      let sexCat = 'Indet.';
      let v = r.sex;
      if (v != null && v !== '') {
        const s = String(v).trim().toUpperCase();
        if (s === '2' || s === 'H' || s === 'HEMBRA') {
          sexCat = 'Hembras';
        } else if (s === '1' || s === 'M' || s === 'MACHO') {
          sexCat = 'Machos';
        } else if (s === '3' || s === 'I' || s.startsWith('INDET')) {
          sexCat = 'Indet.';
        } else {
          sexCat = 'Indet.';
        }
      }

      let slot = emsCounts.get(key);
      if (!slot) {
        slot = { 'Machos': 0, 'Hembras': 0, 'Indet.': 0 };
        emsCounts.set(key, slot);
      }
      slot[sexCat] = (slot[sexCat] || 0) + 1;
      totalEMS++;
    }

    const labels = Array.from(emsCounts.keys()).sort((a, b) => {
      const na = Number(a), nb = Number(b);
      if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
      return String(a).localeCompare(String(b), 'es');
    });

    const sexOrder = ['Machos', 'Hembras', 'Indet.'];

    // Conteos crudos por sexo y EMS
    const rawBySex = {};
    for (const sexKey of sexOrder) {
      rawBySex[sexKey] = labels.map(label => {
        const slot = emsCounts.get(label);
        return slot ? (slot[sexKey] || 0) : 0;
      });
    }

    // Totales por categorÃ­a EMS (para normalizar a 100% por barra)
    const totalByLabel = labels.map((label, idx) => {
      let sum = 0;
      const slot = emsCounts.get(label);
      if (slot) {
        for (const sexKey of sexOrder) {
          sum += slot[sexKey] || 0;
        }
      }
      return sum;
    });

    emsChart.data.labels = labels;

    if (totalEMS > 0) {
      // Convertir a porcentajes por barra (cada EMS suma 100%)
      sexOrder.forEach((sexKey, i) => {
        const ds = emsChart.data.datasets[i];
        const raw = rawBySex[sexKey];
        ds.rawCounts = raw.slice();
        ds.data = raw.map((v, idx) => {
          const denom = totalByLabel[idx] || 0;
          return denom > 0 ? +(v * 100 / denom).toFixed(1) : 0;
        });
      });
      emsChart.update();
    } else {
      // Sin datos: todo en cero
      sexOrder.forEach((sexKey, i) => {
        const ds = emsChart.data.datasets[i];
        ds.rawCounts = labels.map(() => 0);
        ds.data = labels.map(() => 0);
      });
      emsChart.update();
    }

    // Actualizar tabla resumen de EMS (N individuos, N con EMS y % con EMS)
    const tbodyEMS = document.getElementById('emsSummaryBody');
    if (tbodyEMS) {
      const rowEMS = tbodyEMS.querySelector('tr');
      if (rowEMS) {
        const totalSex = (typeof window._vitacTotalSex === 'number') ? window._vitacTotalSex : NaN;
        const nInd = totalSex > 0 ? totalSex : NaN;
        const nEMS = totalEMS;

        const fmtPct = (x) => (x == null || !isFinite(x)) ? 'â€”' : x.toFixed(1).replace('.', ',') + '%';

        const cellsEMS = rowEMS.querySelectorAll('td');
        if (cellsEMS.length >= 3) {
          // N individuos
          cellsEMS[0].textContent = nInd > 0 ? String(nInd) : 'â€”';
          // N con EMS
          cellsEMS[1].textContent = nEMS > 0 ? String(nEMS) : 'â€”';
          // % con EMS respecto del total
          let pctCov = NaN;
          if (nInd > 0 && nEMS > 0) {
            pctCov = nEMS * 100 / nInd;
          }
          cellsEMS[2].textContent = (nInd > 0 && nEMS > 0) ? fmtPct(pctCov) : 'â€”';
        }
      }
    }
  }

}
</script>


<script>
  // Mapa con panes
  var map=L.map('map',{zoomSnap:0.5,zoomDelta:0.5}).setView([-36.8,-73.1],6);
  var baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'});
  var baseEsri=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',{attribution:'Tiles Â© Esri â€” World Ocean Basemap'});
  var gebcoContours=L.tileLayer(
    'https://tiles.arcgis.com/tiles/C8EMgrsFcRFL6LrL/arcgis/rest/services/GEBCO_contours/MapServer/tile/{z}/{y}/{x}',
    {attribution:'Esri, USGS | Esri, TomTom, Garmin, FAO, NOAA, USGS | General Bathymetric Chart of the Oceans (GEBCO); NOAA National Centers for Environmental Information (NCEI)',maxZoom:12}
  );
  var bases=[baseOSM,baseEsri];
  var baseNames=['OSM','Esri Ocean + GEBCO'];
  var baseIdx=0;
  bases[baseIdx].addTo(map);
  document.getElementById('btnBase').addEventListener('click', function(){
    if(bases[baseIdx] && map.hasLayer(bases[baseIdx])) map.removeLayer(bases[baseIdx]);
    if(map.hasLayer(gebcoContours)) map.removeLayer(gebcoContours);
    baseIdx=(baseIdx+1)%bases.length;
    bases[baseIdx].addTo(map);
    if(baseIdx===1){ gebcoContours.addTo(map); }
    this.title='Base: '+baseNames[baseIdx]+' (clic para cambiar)';
  });
const sabanaPane=map.createPane('sabana'); sabanaPane.style.zIndex=400;
  const lancesPane=map.createPane('lances'); lancesPane.style.zIndex=500;
  var mp=document.getElementById('mousePos'); function updateMouse(e){ mp.textContent=`${toDM(e.latlng.lat,true)} , ${toDM(e.latlng.lng,false)}`; } map.on('mousemove', updateMouse); map.once('moveend', function(){ const c=map.getCenter(); updateMouse({latlng:c}); });
  L.Control.NautScale=L.Control.extend({ onAdd:function(map){ const div=L.DomUtil.create('div','leaflet-control nautscale'); div.innerHTML='<div class="label">â€” MN</div><div class="bar" style="width:60px"></div>'; this._label=div.querySelector('.label'); this._bar=div.querySelector('.bar'); map.on('move zoom', this._update, this); this._update(); return div; }, onRemove:function(map){ map.off('move zoom', this._update, this); }, _update:function(){ const mpp=40075016.686*Math.cos(map.getCenter().lat*Math.PI/180)/(256*Math.pow(2,map.getZoom())); const maxPx=120; const maxMeters=mpp*maxPx; const NM=maxMeters/1852; const steps=[1,2,3,5]; const power=Math.floor(Math.log10(NM||1)); let nice=steps[0]*Math.pow(10,power); for(const s of steps){ const v=s*Math.pow(10,power); if(v<=NM) nice=v; } const px=(nice*1852)/mpp; this._bar.style.width=Math.max(10,Math.min(120,Math.round(px)))+'px'; this._label.textContent=(nice<1?nice.toFixed(2):nice<10?nice.toFixed(1):nice.toFixed(0))+' MN'; } }); L.control.nautScale=function(opts){ return new L.Control.NautScale(opts); }; L.control.nautScale({position:'bottomleft'}).addTo(map);

  // SÃ¡bana (sin borde)
  let sabanaLayer=L.layerGroup([], {pane:'sabana'}).addTo(map);
  let sabanaVisible=true, sabanaRows=[], sabanaSpecies=[], sabanaActive=null;

  // Permitir alimentar la sÃ¡bana desde el Excel maestro
  window.setSabanaFromExcel = function(rows){
    // filas crudas desde Excel
    sabanaRows = Array.isArray(rows) ? rows : [];
    window.sabanaRows = sabanaRows;

    // detectar columnas de especie: todas excepto Lon/Lat/UBM
    sabanaSpecies = [];
    const seen = new Set();
    const skip = new Set(['lon_m','lat_m','ubm']);
    sabanaRows.forEach(function(r){
      if (!r) return;
      Object.keys(r).forEach(function(k){
        if (!k) return;
        const lk = String(k).trim().toLowerCase();
        if (skip.has(lk)) return;
        if (seen.has(k)) return;
        seen.add(k);
        sabanaSpecies.push(k);
      });
    });

    // especie activa por defecto
    if (!sabanaSpecies.length){
      sabanaActive = null;
    } else if (!sabanaActive || sabanaSpecies.indexOf(sabanaActive) === -1){
      sabanaActive = sabanaSpecies[0];
    }

    // reconstruir chips y redibujar
    if (typeof buildSpeciesChips === 'function') buildSpeciesChips();
    if (typeof redrawSabana === 'function') redrawSabana();
  };

  const chips=document.getElementById('sabanaChips'); const legend=document.getElementById('sabanaLinearLegend');
  document.getElementById('btnToggleSabana').addEventListener('click', ()=>{ sabanaVisible=!sabanaVisible; if(sabanaVisible){ sabanaLayer.addTo(map); legend.style.display=(sabanaRows.length?'':'none'); } else { map.removeLayer(sabanaLayer); legend.style.display='block'; } });
  function colorClassFor(v){ if(!isFinite(v)||v===0) return {fill:'#9ca3af'}; if(v>0&&v<=640) return {fill:'#facc15'}; if(v>=641&&v<=1280) return {fill:'#22c55e'}; if(v>=1281&&v<=2560) return {fill:'#3b82f6'}; if(v>2560) return {fill:'#ef4444'}; return {fill:'#9ca3af'}; }
  function redrawSabana(){ sabanaLayer.clearLayers(); if(!sabanaActive){ legend.style.display='block'; return; 
  try {
    if (!window.__sabanaLegendShown && sabanaRows && sabanaRows.length){
      const el = document.getElementById('sabanaLinearLegend');
      if (el) { el.style.display = 'block'; window.__sabanaLegendShown = true; }
    }
  } catch(_) {}
} let count=0; sabanaRows.forEach(r=>{ const lat=toNum(r['Lat_M']); const lon=toNum(r['Lon_M']); if(!isFinite(lat)||!isFinite(lon)) return; const v=toNum(r[sabanaActive]); const bucket=colorClassFor(v); const cm=L.circleMarker([lat,lon],{pane:'sabana', radius:5, stroke:false, fillColor:bucket.fill, fillOpacity:.9}).addTo(sabanaLayer); if(isFinite(v)) cm.bindTooltip(`UBM: <b>${(r['UBM']??r['ubm']??r['U B M']??'')}</b><br>${sabanaActive}: <b>${v}</b>`, {direction:'top', offset:[0,-6], sticky:true}); count++; }); legend.style.display=count?'':'none'; info(`SÃ¡bana (${sabanaActive}): ${count} puntos`); }
  function buildSpeciesChips(){ chips.innerHTML=''; sabanaSpecies.forEach((sp,i)=>{ const b=document.createElement('button'); b.className='chip'; var lbl=(sp==='Sardina Comun'||sp==='Sardina ComÃºn'||sp==='Sardina Com n')?'Sardina ComÃºn':sp; b.textContent=lbl; b.dataset.active=(sp===sabanaActive); b.onclick=()=>{ sabanaActive=sp; buildSpeciesChips(); redrawSabana(); }; chips.appendChild(b); if(i===0 && !sabanaActive){ sabanaActive=sp; } }); if(!sabanaActive&&sabanaSpecies.length){ sabanaActive=sabanaSpecies[0]; buildSpeciesChips(); } }
  var sabInput=document.getElementById('sabanaInput');
  if (sabInput) sabInput.addEventListener('change',(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f){ return; } Papa.parse(f,{ header:true, dynamicTyping:false, skipEmptyLines:true, delimiter:'', complete:(r)=>{ const rows=r.data; const fields=(r.meta&&r.meta.fields)?r.meta.fields:(rows.length?Object.keys(rows[0]):[]); const normRows=rows.map(row=>{ const rr={}; for(const k in row){ rr[stdKey(k)]=row[k]; } return rr; }); const startIdx=3; const speciesCols=fields.slice(startIdx).filter(c=>c&&c.trim().length>0); sabanaSpecies=speciesCols; sabanaRows=normRows; buildSpeciesChips(); redrawSabana(); }, error:(err)=>alert('Error leyendo SÃ¡bana: '+err) }); });

  // Lances (encima, con borde negro)
  window.lanceLayer=L.layerGroup([], {pane:'lances'}).addTo(map);
  function drawLanceMarkers(){ lanceLayer.clearLayers(); for(const id of LANCES){ const rows=BY_LANCE.get(id)||[]; if(rows.length===0) continue; const lat=rows.reduce((a,b)=>a+(+b.lat),0)/rows.length; const lon=rows.reduce((a,b)=>a+(+b.lon),0)/rows.length; const selected=selectedLances.has(id);
    const idNum = Number(id);
    let baseFill;
    if (!Number.isNaN(idNum)) {
      // Colores fuertes y muy distintos: verde intenso vs naranjo intenso
      baseFill = (idNum <= 100) ? '#22c55e' : '#f97316';
    } else {
      baseFill = '#22c55e';
    }
    const fill = selected ? '#D946EF' : baseFill;
    const stroke = (document.documentElement.getAttribute('data-theme') === 'dark') ? '#111827' : '#000';
    const mrk=L.circleMarker([lat,lon],{pane:'lances', radius:selected?9:7, weight:2, color:stroke, fillColor:fill, fillOpacity:.85}).addTo(lanceLayer); 
    var anyRow = rows && rows.length ? rows[0] : null;
    var rawDate = anyRow && anyRow.date;
    var dateText = rawDate ? String(rawDate) : '';
    var baseLabel = String(id);
    // Etiqueta permanente: solo nÃºmero de lance
    mrk.bindTooltip(baseLabel, {
      permanent:true,
      direction:'top',
      offset:[0,-10],
      className:'lanceLbl'
    });
    // Tooltip flotante tipo popup al pasar el mouse con la fecha
    if (dateText) {
      var hoverHtml = '<div><b>Lance: ' + baseLabel + '</b><br>Fecha: ' + dateText + '</div>';
      mrk.bindPopup(hoverHtml, {offset:[0,-8], className:'lancePopup'});
      mrk.on('mouseover', function(){
        mrk.openPopup();
      });
      mrk.on('mouseout', function(){
        mrk.closePopup();
      });
    }
    mrk.on('click',()=>{ if(!multi){ selectedLances.clear(); } if(selectedLances.has(id)) selectedLances.delete(id); else selectedLances.add(id); refreshLanceButtons(); updateAll(); drawLanceMarkers(); }); } }
  function fitToLances(){ const coords=[]; for(const id of selectedLances){ const rows=BY_LANCE.get(id)||[]; if(rows.length===0) continue; const lat=rows.reduce((a,b)=>a+(+b.lat),0)/rows.length; const lon=rows.reduce((a,b)=>a+(+b.lon),0)/rows.length; coords.push([lat,lon]); } if(coords.length){ map.fitBounds(coords,{padding:[20,20], maxZoom: 9}); } }
  document.getElementById('btnFit').addEventListener('click', fitToLances);
  window.drawLanceMarkers=drawLanceMarkers; window.fitToLances=fitToLances;
</script>


<script>
(function ensureSabanaNoStroke(){
  function restyle(layerGroup){
    if(!layerGroup) return;
    layerGroup.eachLayer(l=>{
      if (l.setStyle) l.setStyle({stroke:false, weight:0});
    });
  }
  // Common globals: sabanaLayer, layerSabana, capaSabana
  const candidates = [window.sabanaLayer, window.layerSabana, window.capaSabana, window.sabana];
  candidates.forEach(restyle);
  // Also observe future additions
  if (window.sabanaLayer && sabanaLayer.on) {
    sabanaLayer.on('layeradd', e=>{ if (e.layer && e.layer.setStyle) e.layer.setStyle({stroke:false, weight:0}); });
  }
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  (function tryAttachLegend(retries=20){
  const m = window.map;
  if (typeof window.addSabanaLegendOnce === 'function' && m){
    // legend call removed
    if (window.sabanaLegendControl) window.sabanaLegendControl.addTo(m);
  } else if (retries>0){
    setTimeout(()=>tryAttachLegend(retries-1), 150);
  }
})();
});
</script>


<script>
// AÃ±ade tooltip "UBM" (columna C) a los puntos de la SÃ¡bana (robusto, con reintentos)
(function addUBMTooltipsRobust(){
  function toNum(v){
    if (typeof parseDecimal === 'function') return parseDecimal(v);
    if (v===null||v===undefined) return 0;
    const s = String(v).trim().replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  function findUBMForLatLon(lat, lon){
    try {
      const rows = (window.sabanaRows||[]);
      if (!rows.length) return null;
      let bestRow=null, bestDist=Infinity;
      for(const r of rows){
        const la = toNum(r['Lat_M'] ?? r['lat_m'] ?? r['Lat'] ?? r['lat']);
        const lo = toNum(r['Lon_M'] ?? r['lon_m'] ?? r['Lon'] ?? r['lon']);
        if (!isFinite(la) || !isFinite(lo)) continue;
        const d = Math.abs(la - lat) + Math.abs(lo - lon);
        if (d < bestDist){ bestDist = d; bestRow = r; }
      }
      if (bestRow){
        const ubm = bestRow['UBM'] ?? bestRow['ubm'] ?? bestRow['U B M'] ?? null;
        return ubm;
      }
    } catch(e) {}
    return null;
  }
  function attachOnce(){
    const layer = window.sabanaLayer;
    if (!layer || !layer.on) return false;
    layer.on('layeradd', function(e){
      const mk = e.layer;
      if (!mk || !mk.getLatLng || !mk.bindTooltip) return;
      // Defer a tick para asegurar sabanaRows estÃ© poblado
      setTimeout(()=>{
        const ll = mk.getLatLng();
        const ubm = findUBMForLatLon(ll.lat, ll.lng);
        if (ubm !== null && ubm !== undefined){
          try {
            const existing = (mk.getTooltip && mk.getTooltip()) ? mk.getTooltip().getContent() : '';
            const sep = existing ? '<br/>' : '';
            mk.bindTooltip(`${existing}${sep}UBM: <b>${ubm}</b>`, {direction:'top', sticky:true});
          } catch(_){
            mk.bindTooltip(`UBM: <b>${ubm}</b>`, {direction:'top', sticky:true});
          }
        }
      }, 50);
    });
    return true;
  }
  function waitAndAttach(retries=40){
    if (attachOnce()) return;
    if (retries>0) setTimeout(()=>waitAndAttach(retries-1), 100);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>waitAndAttach());
  } else {
    waitAndAttach();
  }
})();
</script>



<script id="contrast-theme-detector">
(function(){
  try {
    var root = document.documentElement;
    var hasAttr = root.hasAttribute('data-theme') || document.body.classList.contains('dark') || document.body.classList.contains('light');
    if (!hasAttr){
      var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) root.setAttribute('data-theme','dark');
    }
  } catch(_) {}
})();
</script>








    




<script id="capturas-chart-js">
(function(){
  function fmtKg(x){ 
    if (x==null || isNaN(x)) return '0';
    return x.toLocaleString('es-CL', {maximumFractionDigits: 3});
  }
  function toFloat(s){
    if (s==null) return NaN;
    s = String(s).trim();
    if (!s) return NaN;
    s = s.replace(/\./g,'').replace(',', '.'); 
    var v = parseFloat(s);
    return isNaN(v) ? NaN : v;
  }
  function normalizeName(x){
    return String(x||'').toLowerCase()
      .replace(/^\ufeff/, '') 
      .replace(/[Ã¡Ã Ã¤]/g,'a').replace(/[Ã©Ã¨Ã«]/g,'e').replace(/[Ã­Ã¬Ã¯]/g,'i')
      .replace(/[Ã³Ã²Ã¶]/g,'o').replace(/[ÃºÃ¹Ã¼]/g,'u')
      .replace(/[^a-z0-9]+/g,'');
  }
  function buildChart(data){
    try {
      var canvas = document.getElementById('capChart');
      if(!canvas){ console.error('capChart canvas no encontrado'); return; }
      var chart = (window.Chart && window.Chart.getChart) ? Chart.getChart(canvas) : null;
      if(!chart && window.Chart){
        chart = new Chart(canvas, {
          type: 'bar',
          data: { labels: [], datasets: [{label:'kg', data: []}] },
          options: {
            responsive: true,
            scales: { y: { ticks: { callback: (v)=>v.toLocaleString('es-CL') } } },
            plugins: { tooltip: { callbacks: { label: (ctx)=>fmtKg(ctx.parsed.y)+' kg' } } }
          }
        });
      }
      if(!chart){ console.error('No hay instancia Chart.js'); return; }
      var labels = data.map(d=>d.especie);
      var values = data.map(d=>d.kg);
      chart.data.labels = labels;
      if (chart.data.datasets && chart.data.datasets[0]){
        chart.data.datasets[0].data = values;
        chart.data.datasets[0].label = 'kg';
      } else {
        chart.data.datasets = [{label:'kg', data: values}];
      }
      chart.update();
      console.log('Capturas: capChart actualizado', {labels, values});
    } catch(err){
      console.error('Error en buildChart', err);
    }
  }
  function aggregate(rows){
    if (!rows || !rows.length){ console.warn('Capturas: sin filas'); return null; }
    var cols = Object.keys(rows[0]||{});
    var norm = cols.map(normalizeName);
    console.log('Capturas: columnas detectadas', cols, norm);
    function findCol(cands){
      for (var i=0;i<norm.length;i++){
        for (var j=0;j<cands.length;j++){
          if (norm[i] === cands[j]) return cols[i];
        }
      }
      return null;
    }
    var keyEsp = findCol(['especie']);
    var keyKg  = findCol(['capturak','kg','kilos','peso','pesokg','capturakg']);
    if (!keyEsp || !keyKg){ 
      console.error('Capturas: columnas no encontradas', {cols, norm}); 
      alert('No se encontraron columnas de especie y kilos en Capturas.csv'); 
      return null; 
    }
    console.log('Capturas: usando columnas', {keyEsp, keyKg});
    var sums = new Map();
    rows.forEach(function(r){
      var esp = r[keyEsp] || 'â€”';
      var raw = r[keyKg];
      var kg = (typeof raw === 'number') ? raw : toFloat(raw);
      if (!isFinite(kg)) return;
      sums.set(esp, (sums.get(esp)||0)+kg);
    });
    var total = 0; sums.forEach(function(v){ total += v; });
    var out = Array.from(sums.entries()).map(function(pair){
      var especie = pair[0], kg = pair[1];
      return {especie: especie, kg: kg, pct: total? (kg*100/total): 0};
    });
    out.sort(function(a,b){ return b.kg-a.kg; });
    console.log('Capturas agregadas:', out);
    return out;
  }
  function setupCapturas(){
    var input = document.getElementById('capturesInput') || document.getElementById('capturasInput') || document.getElementById('fileCapturas');
    if (!input) return;
    input.addEventListener('change', function(){
      var file = input.files && input.files[0];
      if (!file) return;
      if (window.Papa && window.Papa.parse){
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          encoding: "ISO-8859-1",
          complete: function(res){
            try {
              console.log('Capturas: Papa complete', res);
var rows = res.data || [];
window.CAPT_DATA = { rows: rows, keyId: 'lance_id', keyEsp: 'especie', keyKg: 'captura_k' };
var arr = aggregate(rows);
if (arr) buildChart(arr);
renderCapturasChartUsingCaptData(window.selectedLances||new Set());
            } catch(err) {
              console.error('Error procesando Capturas (PapaParse)', err);
              alert('Error procesando Capturas (PapaParse)');
            }
          },
          error: function(err){
            console.error('Error leyendo Capturas.csv (PapaParse)', err);
            alert('Error leyendo Capturas.csv (PapaParse)');
          }
        });
      } else {
        var reader = new FileReader();
        reader.onload = function(e){
          try {
            var text = e.target.result;
            var delim = (text.indexOf(';')>-1 && (text.split(';').length > text.split(',').length)) ? ';' : ',';
            var lines = text.split(/\\r?\\n/).filter(Boolean);
            if (!lines.length) { alert('Archivo vacÃ­o'); return; }
            var head = lines[0].split(delim).map(function(h){ return h.trim(); });
            var rows = lines.slice(1).map(function(line){
              var p = line.split(delim); var o={};
              for (var i=0;i<head.length;i++){ o[head[i]] = (p[i]||'').trim(); }
              return o;
            });
            var arr = aggregate(rows);
            if (arr) buildChart(arr);
          } catch(err) {
            console.error('Error leyendo Capturas.csv (fallback)', err);
            alert('Error leyendo Capturas.csv');
          }
        };
        try { reader.readAsText(file, 'ISO-8859-1'); } catch(_){ reader.readAsText(file); }
      }
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setupCapturas);
  } else {
    setupCapturas();
  }
})();
</script>

    



<script id="freq-unit-toggle-js">
(function(){
  const KEY='freq_unit_pref';
  window.FREQ_UNIT = localStorage.getItem(KEY) || 'pct';
  function syncButton(){
    const b = document.getElementById('freqUnitToggle');
    if (b){
      b.textContent = (window.FREQ_UNIT === 'pct') ? '%' : 'n';
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    syncButton();
    const b = document.getElementById('freqUnitToggle');
    if (b){
      b.addEventListener('click', function(){
        window.FREQ_UNIT = (window.FREQ_UNIT === 'pct') ? 'n' : 'pct';
        try { localStorage.setItem(KEY, window.FREQ_UNIT); } catch(e) {}
        syncButton();
        try { if (typeof updateAll === 'function') updateAll(); } catch(e) {}
      });
    }
  });
})();
</script>

<script id="cap-unit-toggle-js">
(function(){
  const KEY='cap_unit_pref';
  window.CAPT_UNIT = localStorage.getItem(KEY) || 'kg';
  function sync(){ const b=document.getElementById('capUnitToggle'); if(b){ b.textContent = (window.CAPT_UNIT==='pct')?'%':'kg'; } }
  document.addEventListener('DOMContentLoaded', function(){
    const b=document.getElementById('capUnitToggle');
    if(b){
      b.addEventListener('click', function(){
        window.CAPT_UNIT = (window.CAPT_UNIT==='kg') ? 'pct' : 'kg';
        try{ localStorage.setItem(KEY, window.CAPT_UNIT); }catch(_){}
        sync();
        try{ renderCapturasChartUsingCaptData(window.selectedLances||new Set()); }catch(_){}
      });
      sync();
    }
  });
  // Render once on load (in case CAPT_DATA ya estÃ¡)
  window.addEventListener('load', function(){
    try{ renderCapturasChartUsingCaptData(window.selectedLances||new Set()); }catch(_){}
  });
})();
</script>

<script>
// === Visual highlight for lance pills ===
function highlightSelectedLancePills(){
  try{
    const btns = document.querySelectorAll('#lanceBtns > button.pill');
    btns.forEach(b => {
      const id = (b.textContent||'').trim();
      const on = selectedLances && selectedLances.has ? selectedLances.has(isNaN(+id)? id : (+id)) : false;
      b.dataset.state = on ? 'on' : 'off';
    });
  }catch(e){/* no-op */}
}
// Hook into existing refresh if present
const __orig_refreshLanceButtons = typeof refreshLanceButtons==='function' ? refreshLanceButtons : null;
if (__orig_refreshLanceButtons){
  window.refreshLanceButtons = function(){
    __orig_refreshLanceButtons();
    highlightSelectedLancePills();
  };
} else {
  // Fallback: try after DOMContentLoaded
  document.addEventListener('DOMContentLoaded', highlightSelectedLancePills);
}

</script>

<style id="pill-size-override">
  /* Lance pill buttons: slightly smaller for cleaner fit */
  #lanceBtns .pill{
    padding: 4px 8px;
    font-size: 12px;
    line-height: 1.15;
  }
  /* Optional: tighten vertical rhythm on the scroll container */
  #lanceBtns { gap: 6px; }
</style>


<style id="pill-compact-circle-override">
  /* SÃ³lo botones numÃ©ricos dentro de la botonera de lances */
  #lanceBtns{
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
  }
  #lanceBtns .pill{
    padding: 0;                 /* usaremos ancho/alto fijo */
    width: 28px;
    height: 28px;
    border-radius: 999px;       /* cÃ­rculo */
    font-size: 12px;
    line-height: 28px;          /* centra el nÃºmero verticalmente */
    text-align: center;
    border: 1px solid var(--line);
    background: var(--card);
    color: var(--fg);
    box-shadow: none;
  }
  #lanceBtns .pill:hover{
    border-color: var(--accent);
  }
  #lanceBtns .pill[data-state='on']{
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 2px rgba(14,165,233,.18); /* halo suave */
  }
  /* Si hay doble dÃ­gito, evita que se vea apretado en pantallas 100% */
  @media (min-width: 1024px){
    #lanceBtns .pill{ width: 30px; height: 30px; line-height: 30px; font-size: 12px; }
  }
</style>


<script id="species-colors-hook">
// === Paleta por especie (usuario) + fallback estable ===
(function(){
  const SPECIES_PALETTE_20=[
    '#D81B60','#1E88E5','#43A047','#F4511E','#8E24AA',
    '#3949AB','#FB8C00','#00897B','#5E35B1','#7CB342',
    '#FDD835','#00ACC1','#E53935','#6D4C41','#546E7A',
    '#C0CA33','#EC407A','#26A69A','#AB47BC','#FFA726'
  ];
  function normKey(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }
  const USER_SPECIES_COLOR=new Map([
    [normKey('Anchoveta'),'#D81B60'],
    [normKey('Sardina Comun'),'#3949AB'], [normKey('Sardina ComÃºn'),'#3949AB'],
    [normKey('Sardina Austral'),'#43A047'],
    [normKey('Jurel'),'#F4511E'],
    [normKey('Caballa'),'#FDD835'],
    [normKey('Merluza Comun'),'#FFA726'], [normKey('Merluza ComÃºn'),'#FFA726'],
    [normKey('Jibia'),'#546E7A'],
    [normKey('Merluza cola'),'#1E88E5'], [normKey('Merluza de cola'),'#1E88E5'],
    [normKey('Merluza Austral'),'#E53935'],
    [normKey('Otros'),'#9E9E9E']
  ]);
  const REMAINING = SPECIES_PALETTE_20.filter(h=>!Array.from(USER_SPECIES_COLOR.values()).includes(h));
  function pickRest(name){ if(!REMAINING.length) return '#888'; let h=0,s=normKey(name); for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return REMAINING[Math.abs(h)%REMAINING.length]; }
  window.colorForSpecies = function(name){ const k=normKey(name); return USER_SPECIES_COLOR.get(k)||pickRest(name); };
})();
// === LÃ­mites de talla por especie (cm) ===
// Claves ya normalizadas (sin tildes, minÃºsculas, espacios simples)
const SPECIES_SIZE_LIMITS = new Map([
  ['anchoveta',       12.0],  // 12.0 cm
  ['sardina comun',   11.5],  // 11.5 cm
  ['sardina austral', 13.5],  // 13.5 cm
  ['jurel',           26.0]   // 26 cm
]);

function normalizeSpeciesKey(name){
  if (!name) return '';
  // Corregir variantes con carÃ¡cter roto en 'com n' (COM N) antes de normalizar
  let s = String(name);
  s = s.replace(/com n/gi, 'comun');
  return s
    .normalize('NFD').replace(/[Ì€-\u036f]/g,'') // quitar tildes
    .toLowerCase()
    .replace(/\s+/g,' ')
    .trim();
}

// === Rangos fijos de talla por especie para el eje X (cm o mm segÃºn los datos) ===
// Usan las mismas claves normalizadas que normalizeSpeciesKey (sin tildes, minÃºsculas, espacios simples).
const SPECIES_LENGTH_XRANGES = new Map();
(function(){
  function addSpeciesRange(names, minVal, maxVal, step){
    if (!Array.isArray(names)) return;
    names.forEach(function(n){
      const k = normalizeSpeciesKey(n);
      if (!k) return;
      SPECIES_LENGTH_XRANGES.set(k, {min: minVal, max: maxVal, step: step});
    });
  }

  // Jurel / Caballa 5 a 60 cm, escala 1 cm
  addSpeciesRange(['Jurel','Caballa'], 5, 60, 1);

  // Sardina comÃºn / Sardina austral / Anchoveta 0.5 a 22 cm, escala 0.5 cm
  addSpeciesRange(['Sardina Comun','Sardina comÃºn','Sardina austral','Anchoveta'], 0.5, 22, 0.5);

  // Merluza comÃºn 10 a 60 cm, escala 1 cm
  addSpeciesRange(['Merluza Comun','Merluza comÃºn'], 4, 80, 1);

  // Merluza cola / Merluza sur (austral) 20 a 120 cm, escala 1 cm
  // Se incluyen tambiÃ©n abreviaturas usadas en bases: M_Cola, M_Sur, etc.
  addSpeciesRange([
    'Merluza Cola','Merluza de cola','Merluza sur','Merluza del sur','Merluza austral',
    'M_Cola','M Cola','M_Sur','M Sur'
  ], 20, 120, 1);


})();

/**
 * Devuelve un rango fijo de tallas (min, max, step) para las filas indicadas.
 * En mono-especie usa el rango del grupo; en multi-especie usa la uniÃ³n de rangos.
 * Si no se encuentra ningÃºn rango configurado, retorna null.
 */
function getFixedLengthRangeForRows(rows){
  if (!rows || !rows.length || !SPECIES_LENGTH_XRANGES || SPECIES_LENGTH_XRANGES.size === 0) return null;

  const seen = new Set();
  for (let i = 0; i < rows.length; i++){
    const r = rows[i];
    if (!r || !r.species) continue;
    const k = normalizeSpeciesKey(r.species);
    if (SPECIES_LENGTH_XRANGES.has(k)) {
      seen.add(k);
    }
  }

  if (seen.size === 0) return null;

  let min = Infinity;
  let max = -Infinity;
  let step = null;

  for (const k of seen){
    const cfg = SPECIES_LENGTH_XRANGES.get(k);
    if (!cfg) continue;
    if (typeof cfg.min === 'number' && cfg.min < min) min = cfg.min;
    if (typeof cfg.max === 'number' && cfg.max > max) max = cfg.max;
    if (cfg.step != null){
      if (step == null || cfg.step < step) step = cfg.step;
    }
  }

  if (!isFinite(min) || !isFinite(max) || max <= min) return null;
  return {min: min, max: max, step: step};
}


function getSizeLimitForSpecies(name){
  const k = normalizeSpeciesKey(name);
  return SPECIES_SIZE_LIMITS.get(k);
}



// === Hook: aplicar colores en Capturas (dona y barras apiladas) sin tocar otros grÃ¡ficos ===
(function(){
  const orig = window.renderCapturasChartUsingCaptData;
  if (typeof orig!=='function') return;
  window.renderCapturasChartUsingCaptData = function(selectedLancesSet){
    const ChartCtor = window.Chart;
    const ProxyChart = new Proxy(ChartCtor, {
      construct(target, args){
        const [ctx, cfg] = args;
        try{
          if (cfg && cfg.type==='doughnut' && cfg.data && Array.isArray(cfg.data.labels)){
            const labs=cfg.data.labels, cols=labs.map(l=>window.colorForSpecies?colorForSpecies(l):'#888');
            if (cfg.data.datasets && cfg.data.datasets[0]){
              cfg.data.datasets[0].backgroundColor = cols;
              cfg.data.datasets[0].borderColor = cols;
            }
          }
          if (cfg && cfg.type==='bar' && cfg.data && Array.isArray(cfg.data.datasets)){
            cfg.data.datasets.forEach(ds=>{
              const c=window.colorForSpecies?colorForSpecies(ds.label):'#888';
              ds.backgroundColor=c; ds.borderColor=c;
            });
          }
        }catch(e){/* no-op */}
        return new target(...args);
      }
    });
    try{ window.Chart = ProxyChart; return orig(selectedLancesSet); }
    finally{ window.Chart = ChartCtor; }
  };
})();
</script>


<script id="unit-toggle-preserve-selection">
(function(){
  const BTN_ID = 'capUnitToggle';
  function getSel(){
    try{
      if (window.selectedLances && typeof window.selectedLances.forEach === 'function'){
        const arr = [];
        window.selectedLances.forEach(v=>arr.push(v));
        return arr;
      }
    }catch(e){}
    // Fallback: infer from aria-pressed pills
    const arr=[];
    document.querySelectorAll('#lanceBtns > button[aria-pressed="true"], #lanceBtns > button[data-state="on"]').forEach(b=>{
      const t=(b.textContent||'').trim(); arr.push(isNaN(+t)? t : (+t));
    });
    return arr;
  }
  function restoreSel(arr){
    try{
      if (!Array.isArray(arr) || !window.selectedLances || typeof window.selectedLances.clear!=='function') return;
      const old = window.selectedLances;
      // Keep multi flag untouched; just rebuild the set
      old.clear();
      arr.forEach(v=> old.add(v));
      if (typeof window.refreshLanceButtons==='function') window.refreshLanceButtons();
      // Trigger downstream refresh if the app exposes any function
      if (typeof window.refreshAll==='function') window.refreshAll();
      if (typeof window.refreshCharts==='function') window.refreshCharts();
    }catch(e){}
  }
  function flipUnit(btn){
    // Original button likely toggles text between Kg/%; we mirror state in data-unit and localStorage
    const curr = btn.dataset.unit || (btn.textContent.includes('%') ? '%' : 'kg');
    const next = curr === 'kg' ? '%' : 'kg';
    btn.dataset.unit = next;
    try{ localStorage.setItem('capUnitPref', next); }catch(e){}
  }
  function init(){
    const btn = document.getElementById(BTN_ID);
    if (!btn) return;
    // Restore preferred unit once
    try{
      const pref = localStorage.getItem('capUnitPref');
      if (pref) btn.dataset.unit = pref;
    }catch(e){}
    // Wrap existing click handler via capturing listener
    btn.addEventListener('click', function onClickPreserver(ev){
      // snapshot before the app mutates selection/filters
      const snapshot = getSel();
      // Let original click proceed (do not stopPropagation)
      setTimeout(()=> restoreSel(snapshot), 0);
    }, true);
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>


<script id="unit-toggle-sticky-selection">
(function(){
  const BTN_ID = 'capUnitToggle';
  function snapshotSelection(){
    const snap = new Set();
    try{
      if (window.selectedLances && typeof window.selectedLances.forEach==='function'){
        window.selectedLances.forEach(v=> snap.add(v));
      } else {
        document.querySelectorAll('#lanceBtns > button[aria-pressed="true"], #lanceBtns > button[data-state="on"]').forEach(b=>{
          const t=(b.textContent||'').trim();
          const v = isNaN(+t) ? t : (+t);
          snap.add(v);
        });
      }
    }catch(e){}
    return snap;
  }
  const origRender = window.renderCapturasChartUsingCaptData;
  if (typeof origRender === 'function'){
    window.renderCapturasChartUsingCaptData = function(selectedLancesSet){
      if (window.__lastUnitFlipTs && (Date.now() - window.__lastUnitFlipTs < 1200) && window.__selSnapshot instanceof Set){
        selectedLancesSet = window.__selSnapshot;
      }
      return origRender(selectedLancesSet);
    };
  }
  function init(){
    const btn = document.getElementById(BTN_ID);
    if (!btn) return;
    btn.addEventListener('click', function(evt){
      window.__selSnapshot = snapshotSelection();
      window.__lastUnitFlipTs = Date.now();
      try{
        const next = (btn.textContent && btn.textContent.includes('%')) ? '%' : 'kg';
        localStorage.setItem('capUnitPref', next);
      }catch(e){}
    }, true);
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>


<script id="capunit-visibility-single-lance">
(function(){
  const BTN_ID = 'capUnitToggle';
  function getSelectionCount(){
    try{
      if (window.selectedLances && typeof window.selectedLances.size === 'number'){
        return window.selectedLances.size;
      }
    }catch(e){}
    // Fallback: count pills pressed
    let n = 0;
    document.querySelectorAll('#lanceBtns > button[aria-pressed="true"], #lanceBtns > button[data-state="on"]').forEach(()=> n++);
    return n;
  }
  function updateCapUnitVisibility(){
    const btn = document.getElementById(BTN_ID);
    if (!btn) return;
    const sel = getSelectionCount();
    // Ocultar cuando hay SOLO 1 lance (vista donut)
    btn.style.display = (sel === 1) ? 'none' : '';
  }
  // Hook en refreshLanceButtons si existe
  if (typeof window.refreshLanceButtons === 'function'){
    const _orig = window.refreshLanceButtons;
    window.refreshLanceButtons = function(){ _orig(); updateCapUnitVisibility(); };
  }
  // Hook despuÃ©s de render de capturas (por si cambia entre donut/barra)
  const _origRender = window.renderCapturasChartUsingCaptData;
  if (typeof _origRender === 'function'){
    window.renderCapturasChartUsingCaptData = function(selectedLancesSet){
      const r = _origRender(selectedLancesSet);
      try{ updateCapUnitVisibility(); }catch(e){}
      return r;
    };
  }
  // Observa cambios en la botonera de lances
  const root = document.getElementById('lanceBtns');
  if (root){
    const mo = new MutationObserver(()=> setTimeout(updateCapUnitVisibility, 0));
    mo.observe(root, {childList:true, attributes:true, subtree:false});
    root.addEventListener('click', ()=> setTimeout(updateCapUnitVisibility, 0));
    root.addEventListener('change', ()=> setTimeout(updateCapUnitVisibility, 0));
  }
  // Disparos iniciales
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(updateCapUnitVisibility, 0));
  window.addEventListener('load', ()=> setTimeout(updateCapUnitVisibility, 0));
  // Safety net
  setInterval(updateCapUnitVisibility, 1000);
})();
</script>


<script>
(function(){
  var bioInput = document.getElementById('bioInput');
  var fnBio    = document.getElementById('fn_bio');
  var pillsBox = document.getElementById('freqSpeciesPills');
  var elSpecies= document.getElementById('speciesSel');

  window.BIO_ROWS = window.BIO_ROWS || [];

  function autoAdjustBinForSpecies(){
    try{
      var binSel = document.getElementById('binSel');
      if (!binSel) return;
      if (typeof selectedSpeciesSet === 'undefined' || !selectedSpeciesSet || selectedSpeciesSet.size === 0) return;
      var pelagics = ['Anchoveta','Sardina comÃºn','Sardina Comun','Sardina Austral'];
      var hasOnlyPelagic = true;
      selectedSpeciesSet.forEach(function(sp){
        if (pelagics.indexOf(sp) === -1) hasOnlyPelagic = false;
      });
      // Flag global para formato de eje X (pelÃ¡gico vs resto)
      window.isPelagicCurrent = hasOnlyPelagic;
      if (!hasOnlyPelagic) return;
      for (var i = 0; i < binSel.options.length; i++){
        var opt = binSel.options[i];
        var v = opt.value || opt.text;
        if (v === '0.5'){
          binSel.selectedIndex = i;
          break;
        }
      }
    } catch(e){
      console.warn('autoAdjustBinForSpecies error', e);
    }
  }


  window.BIO_ROWS = window.BIO_ROWS || [];
  window.multiSpeciesMode = window.multiSpeciesMode || false;

  function rebuildSpeciesPills(){
    if (!pillsBox) return;
    pillsBox.innerHTML = '';

    // BotÃ³n para activar/desactivar selecciÃ³n multi especie
    var multiBtn = document.createElement('button');
    multiBtn.type = 'button';
    multiBtn.id = 'btnSpeciesMulti';
    multiBtn.className = 'pill';
    multiBtn.textContent = 'Multi especie';
    multiBtn.dataset.state = window.multiSpeciesMode ? 'on' : 'off';
    multiBtn.addEventListener('click', function(){
      window.multiSpeciesMode = !window.multiSpeciesMode;

      // Si se apaga el modo multi, mantener sÃ³lo una especie (para evitar sobreposiciÃ³n innecesaria)
      if (!window.multiSpeciesMode && selectedSpeciesSet && selectedSpeciesSet.size > 1){
        var first = selectedSpeciesSet.values().next().value;
        selectedSpeciesSet = new Set([first]);
        window.selectedSpeciesSet = selectedSpeciesSet;
        selectedSpecies = first;
        if (elSpecies) elSpecies.value = first;
      }

      autoAdjustBinForSpecies();
      if (window.updateAll) window.updateAll();
      rebuildSpeciesPills();
    });
    pillsBox.appendChild(multiBtn);

    var base = (window.BIO_ROWS && window.BIO_ROWS.length) ? window.BIO_ROWS : (window.RAW || []);
    var seen = Object.create(null);
    base.forEach(function(r){
      if (r && r.species){
        var raw = r.species;
        var norm = (typeof normalizeSpecies==='function') ? normalizeSpecies(raw) : raw;
        seen[norm] = true;
      }
    });
    var list = Object.keys(seen).sort();

    // SelecciÃ³n inicial por defecto: al cargar, escoger una especie
    // priorizando pelÃ¡gicos (Anchoveta / Sardinas) y luego Jurel.
    if (list.length && (typeof selectedSpeciesSet === 'undefined' || !selectedSpeciesSet || selectedSpeciesSet.size === 0)){
      selectedSpeciesSet = new Set();
      window.selectedSpeciesSet = selectedSpeciesSet;
      var preferidas = ['Anchoveta','Sardina comÃºn','Sardina Comun','Sardina Austral','Jurel'];
      var elegida = null;
      for (var i = 0; i < preferidas.length; i++){
        if (list.indexOf(preferidas[i]) !== -1){
          elegida = preferidas[i];
          break;
        }
      }
      if (!elegida) elegida = list[0];
      selectedSpeciesSet.add(elegida);
      selectedSpecies = elegida;
      if (elSpecies) elSpecies.value = elegida;
      autoAdjustBinForSpecies();
    }

    list.forEach(function(spNorm){
      var btn = document.createElement('button');
      btn.type = 'button';
      var isSelected = (typeof selectedSpeciesSet !== 'undefined' && selectedSpeciesSet && selectedSpeciesSet.size > 0)
        ? selectedSpeciesSet.has(spNorm)
        : false;
      btn.className = 'pill species-pill' + (isSelected ? ' selected' : '');
      btn.textContent = spNorm;
      btn.addEventListener('click', function(){
        if (typeof selectedSpeciesSet === 'undefined' || !selectedSpeciesSet){
          selectedSpeciesSet = new Set();
          window.selectedSpeciesSet = selectedSpeciesSet;
        }

        if (window.multiSpeciesMode){
          // Modo multi: alternar inclusiÃ³n de la especie
          if (selectedSpeciesSet.has(spNorm)) selectedSpeciesSet.delete(spNorm);
          else selectedSpeciesSet.add(spNorm);
        } else {
          // Modo mono-especie: seleccionar exclusivamente esta especie
          selectedSpeciesSet.clear();
          selectedSpeciesSet.add(spNorm);
        }

        // sincroniza selectedSpecies (modo legado) solo cuando hay una especie
        if (selectedSpeciesSet.size === 1){
          selectedSpecies = Array.from(selectedSpeciesSet)[0];
        } else {
          selectedSpecies = "";
        }

        if (elSpecies) elSpecies.value = selectedSpecies || "";
        autoAdjustBinForSpecies();
        if (window.updateAll) window.updateAll();
        rebuildSpeciesPills();
      });
      pillsBox.appendChild(btn);
    });

  }


  if (elSpecies){
    elSpecies.addEventListener('change', function(){
      var val = this.value || "";
      selectedSpecies = val;
      selectedSpeciesSet.clear();
      if (val){
        var norm = (typeof normalizeSpecies==='function') ? normalizeSpecies(val) : val;
        selectedSpeciesSet.add(norm);
      }
      autoAdjustBinForSpecies();
      rebuildSpeciesPills();
      if (window.updateAll) window.updateAll();
    });
  }

  if (bioInput && window.Papa && window.Papa.parse){
    bioInput.addEventListener('change', function(e){
      var file = e.target.files && e.target.files[0];
      if (!file){
        window.BIO_ROWS = [];
        if (fnBio) fnBio.textContent = 'â€”';
        rebuildSpeciesPills();
        if (window.updateAll) window.updateAll();
        return;
      }
      if (fnBio) fnBio.textContent = file.name;
      Papa.parse(file, {
        header:true,
        skipEmptyLines:true,
        complete:function(res){
          try{
            var rows = res.data || [];
            if (typeof normalizeRow === 'function'){
              rows = rows.map(normalizeRow);
            }
            window.BIO_ROWS = rows.filter(function(r){ return r && r.lance_id!=null; });
            console.log('BiometrÃ­a cargada:', window.BIO_ROWS.length, 'filas');
            rebuildSpeciesPills();
            if (window.updateAll) window.updateAll();
          }catch(err){
            console.error('Error procesando biometrÃ­a:', err);
            window.BIO_ROWS = [];
          }
        },
        error:function(err){
          console.error('Error leyendo CSV de biometrÃ­a:', err);
        }
      });
    });
  }

  // override currentRows para usar BIO_ROWS cuando exista
  if (typeof window.currentRows === 'function'){
    var prevCurrentRows = window.currentRows;
    window.currentRows = function(){
      if (Array.isArray(window.BIO_ROWS) && window.BIO_ROWS.length){
        var src  = window.BIO_ROWS;
        var setL = (typeof selectedLances !== 'undefined' && selectedLances)
          ? selectedLances
          : new Set();
        var sp   = window.selectedSpecies || "";

        var normSet = new Set();
        if (setL && typeof setL.forEach === 'function'){
          setL.forEach(function(id){
            var s = String(id).trim();
            if (!s) return;
            normSet.add(s);
            normSet.add(s.replace(/^L/i,''));
          });
        }

        return src.filter(function(r){
          if (!r) return false;

          var lidRaw  = (r.lance_id != null ? r.lance_id : "");
          var lidStr  = String(lidRaw).trim();
          var lidNorm = lidStr.replace(/^L/i,'');

          var okLance = !normSet.size || normSet.has(lidStr) || normSet.has(lidNorm);

          // Normalizamos especie del registro
          var rs = r.species;
          if (typeof normalizeSpecies==='function' && rs != null){
            rs = normalizeSpecies(rs);
          }

          // Soporte multi-selecciÃ³n de especies
          var okSp = true;
          if (typeof selectedSpeciesSet !== 'undefined' && selectedSpeciesSet && selectedSpeciesSet.size > 0){
            okSp = selectedSpeciesSet.has(rs);
          } else {
            var spNorm = sp;
            if (typeof normalizeSpecies==='function' && spNorm){
              spNorm = normalizeSpecies(spNorm);
            }
            okSp = !spNorm || rs === spNorm;
          }

          var len = r.length_cm;
          if (len == null && r.Longitud != null) len = r.Longitud;
          if (len == null && r.longitud != null) len = r.longitud;
          if (len == null && r.Length_cm != null) len = r.Length_cm;

          var lenNum = null;
          if (len != null){
            var v = Number(String(len).replace(',', '.'));
            if (!Number.isNaN(v)) lenNum = v;
          }

          if (lenNum != null) r.length_cm = lenNum;

          return okLance && okSp && lenNum != null;
        });
      }
      return prevCurrentRows();
    };
  }

  // Enlazar colores de freq y scatter al esquema de especies
  if (typeof window.updateAll === 'function'){
    var prevUpdateAll = window.updateAll;
    window.updateAll = function(){
      // primero ejecutamos el update original
      prevUpdateAll();

      try{
        if (!window.scatterChart || !window.scatterChart.data || !Array.isArray(window.scatterChart.data.datasets)){
          return;
        }

        var dsArr = window.scatterChart.data.datasets || [];

        // Ajuste del rango X con margen usando todos los puntos visibles (todas las especies / lances)
        (function(){
          var allPts = [];
          for (var ai=0; ai<dsArr.length; ai++){
            var dsa = dsArr[ai];
            if (!dsa) continue;
            if (dsa.type === 'line' && dsa.label === 'L-W tendencia') continue;
            if (!Array.isArray(dsa.data)) continue;
            allPts = allPts.concat(dsa.data);
          }
          if (!allPts.length) return;
          var minX = allPts[0] && allPts[0].x;
          var maxX = allPts[0] && allPts[0].x;
          for (var ak=1; ak<allPts.length; ak++){
            var vx = allPts[ak] && allPts[ak].x;
            if (vx == null || isNaN(vx)) continue;
            if (vx < minX) minX = vx;
            if (vx > maxX) maxX = vx;
          }

          // Intentar usar un rango fijo de talla definido por especie(s) (mono/multi especie)
          if (typeof getFixedLengthRangeForRows === 'function' && typeof currentRows === 'function') {
            try {
              var fx = getFixedLengthRangeForRows(currentRows());
              if (fx && isFinite(fx.min) && isFinite(fx.max) && fx.max > fx.min) {
                minX = fx.min;
                maxX = fx.max;
              }
            } catch (e) {
              console.warn('Error aplicando rango fijo L-W:', e);
            }
          }

          if (!isFinite(minX) || !isFinite(maxX)) return;
          var range = maxX - minX;
          var margin = range * 0.05;
          if (!isFinite(margin) || margin <= 0) margin = 0.5;
          if (!scatterChart.options) scatterChart.options = {};
          if (!scatterChart.options.scales) scatterChart.options.scales = {};
          if (!scatterChart.options.scales.x) scatterChart.options.scales.x = {};
          scatterChart.options.scales.x.min = minX - margin;
          scatterChart.options.scales.x.max = maxX + margin;
        })();

        // Decidimos si corresponde o no dibujar la lÃ­nea de tendencia L-W.
        // La mostramos cuando hay una sola especie activa (vÃ­a selectedSpecies o selectedSpeciesSet).
        // En modo multi-lance se considera la tendencia global de los puntos visibles para esa especie.
        var isMulti = (typeof multi !== 'undefined' && multi);
        var hasSet  = (typeof selectedSpeciesSet !== 'undefined' && selectedSpeciesSet && selectedSpeciesSet.size > 0);
        var hasSingleSpecies = false;

        if (hasSet && selectedSpeciesSet.size === 1){
          hasSingleSpecies = true;
        } else if (!hasSet && window.selectedSpecies){
          hasSingleSpecies = true;
        }

        // localizar el dataset de puntos (primer scatter/no-line)
        var pointDs = null;
        for (var i=0;i<dsArr.length;i++){
          var ds = dsArr[i];
          if (!ds) continue;
          // saltamos el dataset de tendencia, si existe
          if (ds.type === 'line' && ds.label === 'L-W tendencia') continue;
          if (!Array.isArray(ds.data) || !ds.data.length) continue;
          pointDs = ds;
          break;
        }

        // helper: limpia/oculta la tendencia si no corresponde
        function clearTrend(){
          for (var j=0;j<dsArr.length;j++){
            var d = dsArr[j];
            if (d && d.type === 'line' && d.label === 'L-W tendencia'){
              d.data = [];
            }
          }
          scatterChart.update();
        }

        // Si no hay una sola especie activa o no hay puntos vÃ¡lidos, no calculamos tendencia
        if (!hasSingleSpecies || !pointDs || !Array.isArray(pointDs.data) || !pointDs.data.length){
          clearTrend();
          return;
        }

        // Usamos todos los puntos visibles (todas las nubes del scatter) para la tendencia global
        var pts = [];
        for (var pi=0; pi<dsArr.length; pi++){
          var dsi = dsArr[pi];
          if (!dsi) continue;
          if (dsi.type === 'line' && dsi.label === 'L-W tendencia') continue;
          if (!Array.isArray(dsi.data)) continue;
          pts = pts.concat(dsi.data);
        }
        if (!pts.length){
          clearTrend();
          return;
        }

        // calcular lÃ­nea de tendencia L-W (modelo potencia W = a * L^b sobre log-log)
        var sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, n = 0;
        for (var t=0;t<pts.length;t++){
          var p = pts[t];
          if (!p || p.x == null || p.y == null) continue;
          if (p.x <= 0 || p.y <= 0) continue;
          var lx = Math.log(p.x);
          var ly = Math.log(p.y);
          if (!isFinite(lx) || !isFinite(ly)) continue;
          sumX += lx;
          sumY += ly;
          sumXY += lx*ly;
          sumXX += lx*lx;
          n++;
        }

        var trendPts = [];
        if (n >= 2){
          var meanX = sumX / n;
          var meanY = sumY / n;
          var denom = (sumXX - n*meanX*meanX);
          if (denom !== 0){
            var b = (sumXY - n*meanX*meanY) / denom; // exponente
            var a = Math.exp(meanY - b*meanX);       // coeficiente

            if (isFinite(a) && isFinite(b)){
              var steps = 30;
              var fromX = pts[0].x;
              var toX   = pts[0].x;
              for (var h=1; h<pts.length; h++){
                if (pts[h].x < fromX) fromX = pts[h].x;
                if (pts[h].x > toX)   toX   = pts[h].x;
              }
              for (var u=0; u<=steps; u++){
                var x = fromX + (toX-fromX)*u/steps;
                if (x <= 0) continue;
                var y = a * Math.pow(x, b);
                if (!isFinite(y)) continue;
                trendPts.push({x:x, y:y});
              }
            }
          }
        }

        // color de la tendencia: usamos el mismo del dataset de puntos
        var color = pointDs.borderColor || pointDs.backgroundColor || '#2196F3';

        // insertamos/actualizamos el dataset de tendencia
        var trendDs = null;
        for (var z=0; z<dsArr.length; z++){
          if (dsArr[z] && dsArr[z].type === 'line' && dsArr[z].label === 'L-W tendencia'){
            trendDs = dsArr[z];
            break;
          }
        }
        if (!trendDs){
          trendDs = {
            type: 'line',
            label: 'L-W tendencia',
            data: trendPts,
            borderColor: color,
            backgroundColor: 'rgba(0,0,0,0)',
            pointRadius: 0,
            borderWidth: 2,
            fill: false,
            tension: 0.1
          };
          dsArr.push(trendDs);
        } else {
          trendDs.data = trendPts;
          trendDs.borderColor = color;
        }

        scatterChart.update();
      }catch(e){
        console.warn('Error actualizando colores de freq/scatter:', e);
      }
    };
  }

  // Exponer funciones al Ã¡mbito global para uso desde el cargador de Excel maestro
  window.rebuildSpeciesPills = rebuildSpeciesPills;
  window.autoAdjustBinForSpecies = autoAdjustBinForSpecies;

  // Inicial: construir pills desde RAW
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    rebuildSpeciesPills();
  }else{
    document.addEventListener('DOMContentLoaded', rebuildSpeciesPills);
  }
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  var mf = document.getElementById('modeFreq');
  if(mf){
    mf.onclick = function(){
      if (!window.freqChart) return;
      try{
        freqChart.config.type = (freqChart.config.type === 'bar' ? 'line' : 'bar');
      }catch(e){}
      try{
        if (typeof updateAll === 'function'){
          updateAll();
        }else if (freqChart && freqChart.update){
          freqChart.update();
        }
      }catch(e){}
    };
  }
});
</script>

<script>
// Capa extra de mapa para CSV "Est. Oceano" + botÃ³n toggle
(function(){
  var extraPane = null;
  var extraLayer = null;
  var extraRows = [];
  var extraVisible = true;

  // Permitir alimentar Est. Oceano desde el Excel maestro
  window.setExtraFromExcel = function(rows){
    extraRows = Array.isArray(rows) ? rows : [];
    window.extraRows = extraRows;
    drawExtra();
  };


  function toNum(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === 'number') return v;
    var s = String(v).trim().replace(',', '.');
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }

  function drawExtra(){
    if (!extraLayer) return;
    extraLayer.clearLayers();
    if (!extraVisible || !Array.isArray(extraRows) || !extraRows.length) return;
    var count = 0;
    extraRows.forEach(function(r){
      var lat = toNum(r.lat ?? r.Lat ?? r.LAT ?? r['Lat_M'] ?? r['lat_m']);
      var lon = toNum(r.lon ?? r.Lon ?? r.LON ?? r['Lon_M'] ?? r['lon_m']);
      if (!isFinite(lat) || !isFinite(lon)) return;
      // Marcador sobrio: punto negro ligeramente mÃ¡s grande
      var m = L.circleMarker([lat, lon], {
        pane: 'extra',
        radius: 5,
        weight: 1,
        color: '#000000',
        fillColor: '#000000',
        fillOpacity: 0.9
      }).addTo(extraLayer);
      var label = r.lance_id ?? r.Lance_ID ?? r.LANCE_ID ?? r['Nombre'] ?? r['name'] ?? r['ID'];
      if (label){
        m.bindTooltip(String(label), {
          direction: 'top',
          offset: [0, -6],
          sticky: true
        });
      }
      count++;
    });
    try{
      if (typeof info === 'function'){
        info('Est. Oceano: ' + count + ' estaciones');
      }
    }catch(_){}
  }


  function handleFile(e){
    var file = e.target.files && e.target.files[0];
    if (!file){
      extraRows = [];
      drawExtra();
      return;
    }
    Papa.parse(file, {
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(res){
        extraRows = res.data || [];
        drawExtra();
      },
      error: function(err){
        console.error(err);
        alert('Error leyendo CSV Est. Oceano: ' + err);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (typeof map !== 'undefined'){
        extraPane = map.createPane('extra');
        extraPane.style.zIndex = 450;
        extraLayer = L.layerGroup([], {pane:'extra'}).addTo(map);
      }
    }catch(e){
      console && console.log && console.log(e);
    }

    var inp = document.getElementById('mapExtraInput');
    if (inp){
      inp.addEventListener('change', handleFile);
    }

    var btn = document.getElementById('btnEstOceano');
    if (btn){
      btn.addEventListener('click', function(){
        extraVisible = !extraVisible;
        btn.classList.toggle('active', extraVisible);
        btn.setAttribute('aria-pressed', extraVisible ? 'true' : 'false');
        drawExtra();
      });
    }
  });
})();
</script>

<script>
// Capa independiente para nÃºmeros de transecta (Num_Tr)
(function(){
  var tranPane = null;
  var tranLayer = null;
  var tranRows = [];
  var tranVisible = true;

  // Permitir alimentar Num_Tr desde el Excel maestro
  window.setTransectsFromExcel = function(rows){
    tranRows = Array.isArray(rows) ? rows : [];
    window.tranRows = tranRows;
    drawTransects();
  };


  function toNum(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === 'number') return v;
    var s = String(v).trim().replace(',', '.');
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }

  function drawTransects(){
    if (!tranLayer) return;
    tranLayer.clearLayers();
    if (!tranVisible || !Array.isArray(tranRows) || !tranRows.length) return;
    var count = 0;
    tranRows.forEach(function(r){
      var lat = toNum(r.lat ?? r.Lat ?? r.LAT ?? r['Lat_M'] ?? r['lat_m']);
      var lon = toNum(r.lon ?? r.Lon ?? r.LON ?? r['Lon_M'] ?? r['lon_m']);
      if (!isFinite(lat) || !isFinite(lon)) return;
      var label = r.Transecta ?? r['Transecta'] ?? r.ID ?? r['ID'] ?? r[''];
      if (label === null || label === undefined || String(label).trim() === '') return;
      var icon = L.divIcon({
        className: 'tran-label',
        html: String(label).trim()
      });
      L.marker([lat, lon], {icon: icon, pane: 'transect'}).addTo(tranLayer);
      count++;
    });
    try{
      if (typeof info === 'function'){
        info('Transectas: ' + count + ' puntos');
      }
    }catch(_){}
  }

  function handleTransectFile(e){
    var file = e.target.files && e.target.files[0];
    if (!file){
      tranRows = [];
      drawTransects();
      return;
    }
    Papa.parse(file, {
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      delimiter: '',
      complete: function(res){
        tranRows = res.data || [];
        drawTransects();
      },
      error: function(err){
        console.error(err);
        alert('Error leyendo CSV Num_Tr: ' + err);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (typeof map !== 'undefined'){
        tranPane = map.createPane('transect');
        tranPane.classList.add('transect-pane');
        tranLayer = L.layerGroup([], {pane:'transect'}).addTo(map);
      }
    }catch(e){
      console && console.log && console.log(e);
    }

    var inp = document.getElementById('mapTransectInput');
    if (inp){
      inp.addEventListener('change', handleTransectFile);
    }

    var btn = document.getElementById('btnNumTr');
    if (btn){
      btn.addEventListener('click', function(){
        tranVisible = !tranVisible;
        btn.classList.toggle('active', tranVisible);
        btn.setAttribute('aria-pressed', tranVisible ? 'true' : 'false');
        drawTransects();
      });
    }
  });
})();
</script>

<script>
// Capa independiente para Track de navegaciÃ³n (por Ã­ndice con reinicio en 0)
(function(){
  var trkPane = null;
  var trkLayer = null;
  var trkRows = [];
  var trkVisible = true;

  // Permitir alimentar Track desde el Excel maestro
  window.setTrackFromExcel = function(rows){
    trkRows = Array.isArray(rows) ? rows : [];
    window.trkRows = trkRows;
    drawTrack();
  };


  function toNumTrack(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === 'number') return v;
    var s = String(v).trim().replace(',', '.');
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }

  function drawTrack(){
    if (!trkLayer) return;
    trkLayer.clearLayers();
    if (!trkVisible || !Array.isArray(trkRows) || !trkRows.length) return;

    // Agrupar por barco / nave para colorear distinto cada track
    var byVessel = {};
    trkRows.forEach(function(r){
      var vesselRaw = r.Buque ?? r['Buque'] ??
                      r.Barco ?? r['Barco'] ??
                      r.Nave  ?? r['Nave']  ??
                      r.Vessel ?? r['Vessel'] ??
                      r.Ship ?? r['Ship'] ??
                      r.Barca ?? r['Barca'] ??
                      r['Nombre_Buque'] ?? r['Nombre_barco'] ?? r['Nombre Barco'];
      var vessel = (vesselRaw == null ? '' : String(vesselRaw).trim());
      if (!vessel) vessel = '_UNSPECIFIED_';
      if (!byVessel[vessel]) byVessel[vessel] = [];
      byVessel[vessel].push(r);
    });

    var palette = [
      '#0000ff', // azul puro
      '#ff0000', // rojo puro
      '#555555', // gris respaldo
      '#999999'  // gris claro respaldo
    ];

    var totalSegs = 0;
    var vesselNames = Object.keys(byVessel);

    vesselNames.forEach(function(vName, vIdx){
      var rows = byVessel[vName];
      if (!rows || !rows.length) return;

      var segments = [];
      var current = [];

      rows.forEach(function(r){
        var lat = toNumTrack(r.lat ?? r.Lat ?? r.LAT ?? r['Lat_M'] ?? r['lat_m']);
        var lon = toNumTrack(r.lon ?? r.Lon ?? r.LON ?? r['Lon_M'] ?? r['lon_m']);
        if (!isFinite(lat) || !isFinite(lon)) return;

        var idxRaw = r.Transecta ?? r['Transecta'] ??
                     r.Numero   ?? r['Numero']   ??
                     r.ID       ?? r['ID']       ??
                     r['Unnamed: 2'] ?? r[''];
        var idx = toNumTrack(idxRaw);
        if (!isFinite(idx)) return;

        // Cuando el Ã­ndice vuelve a 0, cerramos el segmento anterior
        if (idx === 0 && current.length){
          if (current.length > 1) segments.push(current);
          current = [];
        }
        current.push([lat, lon]);
      });

      if (current.length > 1){
        segments.push(current);
      }

      var color = palette[vIdx % palette.length];

      segments.forEach(function(coords){
        if (coords.length < 2) return;
        L.polyline(coords, {
          pane: 'track',
          weight: 3,
          color: color,
          opacity: 0.9
        }).addTo(trkLayer);
        totalSegs++;
      });
    });

    try{
      if (typeof info === 'function'){
        var msg = 'Track: ' + totalSegs + ' transectas (por Ã­ndice)';
        if (vesselNames.length > 1){
          msg += ' | ' + vesselNames.length + ' barcos';
        }
        info(msg);
      }
    }catch(_){}
  }


  function handleTrackFile(e){
    var file = e.target.files && e.target.files[0];
    if (!file){
      trkRows = [];
      drawTrack();
      return;
    }
    Papa.parse(file, {
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      delimiter: '',
      complete: function(res){
        trkRows = res.data || [];
        drawTrack();
      },
      error: function(err){
        console.error(err);
        alert('Error leyendo CSV Track: ' + err);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (typeof map !== 'undefined'){
        trkPane = map.createPane('track');
        trkPane.classList.add('track-pane');
        trkLayer = L.layerGroup([], {pane:'track'}).addTo(map);
      }
    }catch(e){
      console && console.log && console.log(e);
    }

    var inp = document.getElementById('mapTrackInput');
    if (inp){
      inp.addEventListener('change', handleTrackFile);
    }

    var btn = document.getElementById('btnTrack');
    if (btn){
      btn.addEventListener('click', function(){
        trkVisible = !trkVisible;
        btn.classList.toggle('active', trkVisible);
        btn.setAttribute('aria-pressed', trkVisible ? 'true' : 'false');
        drawTrack();
      });
    }
  });
})();
</script>

// <script>// Marca los pills de carga en verde y actualiza el estado x/x
document.addEventListener('DOMContentLoaded', function(){
  var fileConfigs = [
    { inputId: 'fileInput',       labelId: 'fn_lances'   },
    { inputId: 'sabanaInput',     labelId: 'fn_sabana'   },
    { inputId: 'capturesInput',   labelId: 'fn_capturas' },
    { inputId: 'bioInput',        labelId: 'fn_bio'      },
    { inputId: 'mapExtraInput',   labelId: 'fn_mapextra' },
    { inputId: 'mapTransectInput',labelId: 'fn_numtr'    },
    { inputId: 'mapTrackInput',   labelId: 'fn_track'    }
  ];

  function refreshFileUI(){
    var loaded = 0;
    fileConfigs.forEach(function(cfg){
      var input = document.getElementById(cfg.inputId);
      var span  = document.getElementById(cfg.labelId);
      if (!input || !span) return;
      var label = input.closest('label.filetag');

      var hasFile = input.files && input.files.length > 0;
      if (hasFile){
        loaded++;
        if (label) label.classList.add('has-file');
        if (input.files.length === 1){
          span.textContent = input.files[0].name;
        } else {
          span.textContent = input.files.length + ' archivos';
        }
      } else {
        if (label) label.classList.remove('has-file');
        span.textContent = 'â€”';
      }
    });

    var status = document.getElementById('fileStatus');
    if (status){
      var total = fileConfigs.length;
      status.textContent = loaded + '/' + total + (loaded === total ? ' Â· listo' : ' Â· esperandoâ€¦');
    }
  }

  fileConfigs.forEach(function(cfg){
    var input = document.getElementById(cfg.inputId);
    if (input){
      input.addEventListener('change', refreshFileUI);
    }
  });

  // Primera actualizaciÃ³n
  refreshFileUI();
});
</script>


<script>
// Cargador de Excel maestro (7 hojas) para VITAC
document.addEventListener('DOMContentLoaded', function(){
  var excelInput = document.getElementById('excelInput');
  if (!excelInput || typeof XLSX === 'undefined') return;

  var fnExcel   = document.getElementById('fn_excel');
  var fnLances  = document.getElementById('fn_lances');
  var fnSabana  = document.getElementById('fn_sabana');
  var fnCapts   = document.getElementById('fn_capturas');
  var fnBio     = document.getElementById('fn_bio');
  var fnExtra   = document.getElementById('fn_mapextra');
  var fnNumTr   = document.getElementById('fn_numtr');
  var fnTrack   = document.getElementById('fn_track');
  var statusEl  = document.getElementById('fileStatus');

  function setStatus(msg){
    if (statusEl) statusEl.textContent = msg;
  }

  function sheetToJson(workbook, wantedNames){
    if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) return [];
    var lowerWanted = wantedNames.map(function(n){ return String(n).toLowerCase(); });

    function normalizeName(name){
      return String(name).trim().toLowerCase();
    }

    var chosen = null;
    // 1) match exact (case-insensitive)
    workbook.SheetNames.forEach(function(name){
      if (chosen) return;
      var ln = normalizeName(name);
      lowerWanted.forEach(function(w){
        if (ln === w && !chosen){
          chosen = name;
        }
      });
    });
    // 2) partial match si no hubo exacta
    if (!chosen){
      workbook.SheetNames.forEach(function(name){
        if (chosen) return;
        var ln = normalizeName(name);
        lowerWanted.forEach(function(w){
          if (ln.indexOf(w) !== -1 && !chosen){
            chosen = name;
          }
        });
      });
    }
    if (!chosen) return [];

    var sheet = workbook.Sheets[chosen];
    if (!sheet) return [];
    try{
      return XLSX.utils.sheet_to_json(sheet, {defval: null});
    }catch(e){
      console.error('sheet_to_json error', e);
      return [];
    }
  }

  
  // Funciones auxiliares para procesar el Excel maestro (local o desde GitHub)
  function processWorkbook(wb, sourceLabel){
var loaded = 0;

        // 1) Lances
        var lancesRows = sheetToJson(wb, ['Lances']);
        if (Array.isArray(lancesRows) && lancesRows.length && typeof loadRows === 'function'){
          // Reutiliza el pipeline original de Lances
          loadRows(lancesRows);
          loaded++;
          if (fnLances) fnLances.textContent = 'Lances: ' + lancesRows.length;
        } else if (fnLances){
          fnLances.textContent = 'Lances: 0';
        }

        // 2) BiometrÃ­a
        var bioRows = sheetToJson(wb, ['Biometria','BiometrÃ­a']);
        if (!Array.isArray(bioRows)) bioRows = [];
        if (typeof normalizeRow === 'function' && bioRows.length){
          bioRows = bioRows.map(function(r){ return normalizeRow(r); });
        }
        window.BIO_ROWS = bioRows.filter(function(r){ return r && r.lance_id != null; });
        if (fnBio) fnBio.textContent = 'BiometrÃ­a: ' + window.BIO_ROWS.length;
        if (window.BIO_ROWS.length) loaded++;
        if (typeof rebuildSpeciesPills === 'function') rebuildSpeciesPills();
        if (typeof updateAll === 'function') updateAll();

        // 3) Capturas
        var captRows = sheetToJson(wb, ['Capturas']);
        if (!Array.isArray(captRows)) captRows = [];
        window.CAPT_DATA = { rows: captRows, keyId: 'lance_id', keyEsp: 'especie', keyKg: 'captura_k' };
        if (fnCapts) fnCapts.textContent = 'Capturas: ' + captRows.length;
        if (captRows.length) loaded++;
        if (typeof renderCapturasChartUsingCaptData === 'function'){
          try{
            renderCapturasChartUsingCaptData(window.selectedLances || new Set());
          }catch(e){
            console.warn('renderCapturasChartUsingCaptData error', e);
          }
        }

        // 4) SÃ¡bana
        var sabRows = sheetToJson(wb, ['Sabana','SÃ¡bana']);
        if (!Array.isArray(sabRows)) sabRows = [];
        if (typeof window.setSabanaFromExcel === 'function'){
          window.setSabanaFromExcel(sabRows);
        }
        if (fnSabana) fnSabana.textContent = 'SÃ¡bana: ' + sabRows.length;
        if (sabRows.length) loaded++;

        // 5) Estaciones OceanogrÃ¡ficas
        var estRows = sheetToJson(wb, ['Estaciones Oceanograficas','Estaciones OceanogrÃ¡ficas','Est. Oceano']);
        if (!Array.isArray(estRows)) estRows = [];
        if (typeof window.setExtraFromExcel === 'function'){
          window.setExtraFromExcel(estRows);
        }
        if (fnExtra) fnExtra.textContent = 'Est. Oceano: ' + estRows.length;
        if (estRows.length) loaded++;

        // 6) Num_Tr
        var numTrRows = sheetToJson(wb, ['Num_Tr','Num Tr']);
        if (!Array.isArray(numTrRows)) numTrRows = [];
        if (typeof window.setTransectsFromExcel === 'function'){
          window.setTransectsFromExcel(numTrRows);
        }
        if (fnNumTr) fnNumTr.textContent = 'Num. Tr: ' + numTrRows.length;
        if (numTrRows.length) loaded++;

        // 7) Track
        var trackRows = sheetToJson(wb, ['Track']);
        if (!Array.isArray(trackRows)) trackRows = [];
        if (typeof window.setTrackFromExcel === 'function'){
          window.setTrackFromExcel(trackRows);
        }
        if (fnTrack) fnTrack.textContent = 'Track: ' + trackRows.length;
        if (trackRows.length) loaded++;

        
        setStatus(loaded + '/7 Â· Excel maestro listo' + (sourceLabel ? ' Â· ' + sourceLabel : ''));
  }

  function loadExcelFromArrayBuffer(buffer, sourceLabel){
    try{
      var data = new Uint8Array(buffer);
      var wb = XLSX.read(data, {type:'array'});
      processWorkbook(wb, sourceLabel);
    }catch(err){
      console.error('Error procesando Excel maestro desde ArrayBuffer:', err);
      setStatus('Error al leer el Excel maestro');
    }
  }

excelInput.addEventListener('change', function(e){
    var file = e.target.files && e.target.files[0];
    if (!file){
      setStatus('0/7 Â· esperando Excel maestroâ€¦');
      if (fnExcel) fnExcel.textContent = 'â€”';
      return;
    }
    if (fnExcel) fnExcel.textContent = file.name;
    setStatus('Cargando Excel maestroâ€¦');

    var reader = new FileReader();
    reader.onload = function(ev){
      try{
        loadExcelFromArrayBuffer(ev.target.result, file && file.name ? file.name : 'Excel local');
      }catch(err){
        console.error('Error procesando Excel maestro:', err);
        setStatus('Error al leer el Excel maestro');
      }
    };    reader.onerror = function(err){
      console.error('FileReader error:', err);
      setStatus('Error leyendo archivo Excel');
    };
    reader.readAsArrayBuffer(file);
  });

  // Carga automÃ¡tica del Excel maestro por defecto cuando se abre el VITAC (por ejemplo en GitHub Pages)
  (function autoLoadDefaultExcel(){
    try{
      if (location.protocol === 'file:') return; // no estorbar en uso local
      if (typeof fetch === 'undefined') return;

      var DEFAULT_EXCEL_PATH = 'EXCEL_MAESTRO_VITAC.xlsx';

      // Estado mientras se intenta cargar
      setStatus('Cargando Excel maestro por defectoâ€¦');

      fetch(DEFAULT_EXCEL_PATH)
        .then(function(resp){
          if (!resp.ok){
            throw new Error('HTTP ' + resp.status);
          }
          return resp.arrayBuffer();
        })
        .then(function(buffer){
          if (fnExcel) fnExcel.textContent = DEFAULT_EXCEL_PATH;
          loadExcelFromArrayBuffer(buffer, 'Excel por defecto');
        })
        .catch(function(err){
          console.warn('No se pudo cargar el Excel maestro por defecto:', err);
          setStatus('0/7 Â· esperando Excel maestroâ€¦');
        });
    }catch(err){
      console.warn('Fallo en autoLoadDefaultExcel:', err);
    }
  })();
});
</script>


<script id="sabana-eye-toggle">
document.addEventListener('DOMContentLoaded', function(){
  try{
    var btn = document.getElementById('btnToggleSabana');
    if (!btn) return;
    var eyeOn = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
    var eyeOff = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"></path><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"></path><path d="M10.58 10.58a3 3 0 0 0 4.24 4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
    var isOff = false;
    // inicial: ojo abierto
    btn.innerHTML = eyeOn;
    btn.addEventListener('click', function(){
      isOff = !isOff;
      btn.innerHTML = isOff ? eyeOff : eyeOn;
    });
  }catch(e){
    console && console.log && console.log(e);
  }
});
</script>
</body>
</html>
